---
title: "Calculating temporal biomass change"
author: "Denisse Fierro Arcos"
date: "2024-04-30"
output: pdf_document
---

## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
rm(list = ls())
#Data wrangling
library(tidyverse)
library(data.table)
```

## Setting up notebook

```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}
```
  
## Loading mask and area of grid cell for IPSL and GFDL models
  
```{r}
#Getting GFDL grid area
area_gfdl_df <- list.files(out_folder, "gfdl-esm4_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()

#Getting IPSL grid area
area_ipsl_df <- list.files(out_folder, "ipsl-cm6a_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()

# adding FAO official short names for countries and territories 
## NOTE - this won't be needed if area_gfdl_df and area_ipsl_df will be recreated using EEZ_FAO_key_with_short_names_utf.csv  
short_names <- file.path(out_folder, "Merged_FAO_EEZ/EEZ_FAO_key_with_short_names_utf.csv") |> 
  read.csv(fileEncoding = "UTF-8") %>% 
  select(-ID_mrgd) %>% # merge by fa_ffcl
  rename(contnnt = continent, fa_ffcl = fao_official, Cnt_FAO = Country_FAO, fa_ffcl_shrt = figure_name)

area_gfdl_df<-area_gfdl_df %>% 
  select(-contnnt, -Cnt_FAO) %>% # replace also info on continent and country as there might have been small changes during the creation and revision of the short_names file
  mutate(fa_ffcl = ifelse(fa_ffcl == "the United States Minor Outlying Islands (Howland and Baker Islands)", "Howland and Baker Islands", fa_ffcl)) %>% # adjustment to country name done on "short_names"
  left_join(short_names)

area_ipsl_df<-area_ipsl_df %>% 
  select(-contnnt, -Cnt_FAO) %>% 
  mutate(fa_ffcl = ifelse(fa_ffcl == "the United States Minor Outlying Islands (Howland and Baker Islands)", "Howland and Baker Islands", fa_ffcl)) %>% # adjustment to country name done on "short_names"
  left_join(short_names)

```
  
## Getting FishMIP output files
  
```{r}

#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()

```
  
## Calculating percentage change in fish biomass mean per country from global FishMIP models
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells with countries recognised by FAO
  area_grid <- area_grid |> 
    drop_na(fa_ffcl) |> 
    #Remove columns that are not relevant
    select(!c(ID_mrgd, OCEAN, NAME_EN, Cnt_FAO))
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and country
    left_join(area_grid, by = join_by(x, y)) |>
    #Calculate weighted mean for biomass per ensemble member per country
    group_by(year, mem, esm, scenario, contnnt, fa_ffcl, fa_ffcl_shrt) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T)) |> 
    #Remove rows outside country boundaries
    drop_na(fa_ffcl)
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    group_by(contnnt, fa_ffcl, fa_ffcl_shrt) |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    left_join(ref_bio, join_by(contnnt, fa_ffcl, fa_ffcl_shrt)) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)
  
  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_country.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass per country
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_country.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows()
  
#Create name to save file
f_out <- file.path(out_folder, "mem_perc_bio_change_country.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

bio_data <- bio_data |>
  group_by(year, scenario, contnnt, fa_ffcl, fa_ffcl_shrt) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))


#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_country.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
## Calculating percentage change in fish biomass mean per FAO region from global FishMIP models
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells with FAO regions
  area_grid <- area_grid |> 
    drop_na(NAME_EN) |>
    #Remove columns that are not relevant
    select(x,y,cell_area, NAME_EN)
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and within FAO regions
    left_join(area_grid, by = join_by(x, y)) |>
    #Calculate weighted mean for biomass per ensemble member per FAO
    group_by(year, mem, esm, scenario, NAME_EN) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T)) |> 
    #Remove rows outside country boundaries
    drop_na(NAME_EN)
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    group_by(NAME_EN) |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    left_join(ref_bio, join_by(NAME_EN)) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)

  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_fao_region.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass per FAO region
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_fao_region.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows()
  
#Create name to save file
f_out <- file.path(out_folder, "mem_perc_bio_change_fao_region.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

bio_data <- bio_data |>
  group_by(year, scenario, NAME_EN) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_fao_region.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
## Calculating percentage change in fish biomass mean globally from global FishMIP models
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells within country boundaries
  area_grid <- area_grid |> 
    drop_na(fa_ffcl) |>
    #Remove columns that are not relevant
    select(x:cell_area)
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and area ID
    left_join(area_grid, by = join_by(x, y)) |>
    #Removing grid cells outside countries
    drop_na(cell_area) |> 
    #Calculate weighted mean for biomass per ensemble member globally
    group_by(year, mem, esm, scenario) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T))
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    ungroup() |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    mutate(ref_bio = ref_bio$ref_bio) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)
  
  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_global.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass for entire globe
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_global.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows()
  
#Create name to save file
f_out <- file.path(out_folder, "mem_perc_bio_change_global.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

bio_data <- bio_data |>
  group_by(year, scenario) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_global.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
## Calculating percentage change in fish biomass mean from global FishMIP models in the top 7 countries with highest catches
  
```{r}
#Defining top 7 countries by catch
top_7 <- c("China", "India", "Indonesia", "Peru", "Russian", 
           "United States of America", "Viet")

#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells with countries recognised by FAO
  #Extracting data from countries calculations
  area_grid <- area_grid |> 
    filter(str_detect(Cnt_FAO, paste0(top_7, collapse = "|"))) |> 
    #Remove continent information
    select(!c(ID_mrgd,OCEAN,NAME_EN,fa_ffcl,fa_ffcl_shrt))

  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and country
    left_join(area_grid, by = join_by(x, y)) |>
    drop_na(Cnt_FAO) |> 
    #Calculate weighted mean for biomass per ensemble member per country
    group_by(year, mem, esm, scenario, Cnt_FAO) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T))
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    group_by(Cnt_FAO) |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    left_join(ref_bio, join_by(Cnt_FAO)) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)
  
  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_top7countries.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass for top 7 countries
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_top7countries.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows()

#Create name to save file
f_out <- file.path(out_folder, "mem_perc_bio_change_top7countries.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

bio_data <- bio_data |>
  group_by(year, scenario, Cnt_FAO) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_top7countries.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  