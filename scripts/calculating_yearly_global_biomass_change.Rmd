---
title: "Calculating temporal biomass change"
author: "Denisse Fierro Arcos"
date: "2024-04-30"
output: pdf_document
---

## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
library(data.table)
```

## Setting up notebook

```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}
```
  
## Loading mask and area of grid cell for IPSL and GFDL models
  
```{r}
#Getting GFDL grid area
area_gfdl_df <- list.files(out_folder, "gfdl-esm4_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()

#Getting IPSL grid area
area_ipsl_df <- list.files(out_folder, "ipsl-cm6a_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()
```
  
## Getting FishMIP output files
  
```{r}
#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()
```
  
## Calculating percentage change in fish biomass mean per country from global FishMIP models
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells with countries recognised by FAO
  area_grid <- area_grid |> 
    drop_na(fa_ffcl) |> 
    #Remove columns that are not relevant
    select(!ID_mrgd:nm_mrgd)
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and area ID (FAO and EEZ)
    left_join(area_grid, by = join_by(x, y)) |>
    #Calculate weighted mean for biomass per ensemble member per EEZ/FAO
    group_by(year, mem, esm, scenario, contnnt, fa_ffcl) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T)) |> 
    #Remove rows outside country boundaries
    drop_na(fa_ffcl)
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    group_by(contnnt, fa_ffcl) |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    left_join(ref_bio, join_by(contnnt, fa_ffcl)) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)
  
  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_country.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass per country
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_country.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows() |> 
  group_by(year, scenario, contnnt, fa_ffcl) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))


#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_country.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
## Calculating percentage change in fish biomass mean per FAO region from global FishMIP models
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  #Keep only information for grid cells with FAO regions
  area_grid <- area_grid |> 
    drop_na(NAME_EN) |>
    #Remove columns that are not relevant
    select(x:cell_area, NAME_EN)
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and area ID (FAO and EEZ)
    left_join(area_grid, by = join_by(x, y)) |>
    #Calculate weighted mean for biomass per ensemble member per EEZ/FAO
    group_by(year, mem, esm, scenario, NAME_EN) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T)) |> 
    #Remove rows outside country boundaries
    drop_na(NAME_EN)
  
  #Calculating reference period
  ref_bio <- df_model |> 
    filter(year >= 2005 & year <= 2014) |> 
    group_by(NAME_EN) |> 
    #Calculate mean per ensemble member
    summarise(ref_bio = mean(mean_bio, na.rm = T))
  
  #Add reference period to weighted mean data frame
  df_model <- df_model |> 
    left_join(ref_bio, join_by(NAME_EN)) |> 
    #Calculate percentage change
    mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100)
  
  #Create name to save file
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_perc_bio_change_fao_region.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean ensemble percentage change in biomass per FAO region
  
```{r eval = F}
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_fao_region.csv",
                       full.names = T, recursive = T) |> 
  map(~fread(.)) |> 
  bind_rows() |> 
  group_by(year, scenario, NAME_EN) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_fao_region.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
  