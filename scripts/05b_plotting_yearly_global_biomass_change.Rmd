---
title: "Temporal biomass change"
author: "Denisse Fierro Arcos"
date: "2024-01-17"
output: pdf_document
---

# Introduction - Forcing file divergence

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
library(data.table)
#Raster data
library(terra)
#Combining plots
library(cowplot)
```

## Setting up notebook
This notebook uses a modified version of the Exclusive Economic Zones boundaries (version 11) from the [Flanders Marine Institute (2019)](https://doi.org/10.14284/386). Available [online](https://www.marineregions.org/). The following modifications were made:  
- Boundaries for South Georgia and Sandwich Islands were updated to boundaries provided by the UN  
- Boundaries around Bouvet Island (Norway) in the south Atlantic were added to this shapefile  
- Country boundaries were dissolved and polygons were reclassified by continent  
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

#EEZ keys
eez_keys <- read.csv(list.files(out_folder, 
                           pattern = "EEZ_keys_updated.csv", 
                           full.names = T, recursive = T), 
                     encoding = "UTF-8") |> 
  #Keeping relevant columns
  select(ID_mrgd, Name_EEZ, region, Country_FAO, 
         Official_Name_En_Stefania_NEW) |> 
  #Renaming columns
  rename("continent" = "region", 
         "fao_official" = "Official_Name_En_Stefania_NEW") |> 
  #Removing jointly managed areas and overlapping claims from original EEZ file
  filter(str_detect(Name_EEZ, "Overlapping|Joint", negate = T)) |> 
  #Removing unaccepted EEZ names
  select(!Name_EEZ)

#FAO keys
fao <- read_csv(list.files(out_folder, 
                           pattern = "FAO_MajorAreas_200NM_cont_keys.csv", 
                           full.names = T, recursive = T)) |> 
  #Keep FAO areas only
  drop_na(OCEAN) |> 
  #Removing duplicates
  distinct() |> 
  #Keep relevant columns only
  select(ID_mrgd, OCEAN, NAME_EN)

#Merging FAO and EEZ keys
fao_eez_keys <- fao |>
  bind_rows(eez_keys) |> 
  #Keep all official names in a single column for FAO and EEZ areas
  mutate(fao_official = case_when(is.na(fao_official) ~ NAME_EN, 
                                  T ~ fao_official)) |> 
  #Remove duplicate column
  select(!NAME_EN)
  
#Removing individual keys
rm(eez_keys, fao)

#FAO_EEZ mask - Contains IDs for FAO and EEZ areas
fao_eez_mask <- read_csv(list.files(out_folder, 
                                    pattern = "FAO_Major_200NM_masked_area_1deg.csv",
                                    full.names = T, recursive = T)) |> 
  #Renaming ID column
  rename("ID_mrgd" = "mask") |> 
  #Adding official names to be used in plots
  left_join(fao_eez_keys[,c("ID_mrgd", "fao_official")], 
            by = join_by(ID_mrgd))

#Loading area per grid cell
area_grid <- rast(list.files(out_folder, pattern = "^area_1deg.nc", 
                             recursive = T, full.names = T)) |> 
  #Transform to data frame
  as.data.frame(xy = T) |> 
  #Join with FAO keys
  left_join(fao_eez_mask, by = join_by(x, y))

#Removing mask without area values
rm(fao_eez_mask)

#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()
```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Add area for each grid cell and area ID (FAO and EEZ)
    left_join(area_grid, by = join_by(x, y)) |> 
    #Removing areas not recognised in FAO official name list
    drop_na(fao_official) |> 
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario, fao_official) |> 
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))
  
  #Create name to save file  
  f_out <- file.path(out_folder, str_c(m, "_yearly_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean for reference period
Plots created here will show percentage change in biomass over time under two emissions scenarios: `SSP1-2.6` and `SSP5-8.5`. Our reference period is 2005-2014.  
  
```{r eval = F}
#Listing all relevant files to calculate biomass projections
bio_data <- list.files(out_folder, pattern = "_yearly_perc_bio_change_data.csv",
                       full.names = T) |> 
  map_df(~fread(.))

#Calculating reference period
ref_bio <- bio_data |> 
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per ensemble member
  group_by(mem, esm, fao_official) |> 
  summarise(ref_bio = mean(mean_bio, na.rm = T))

#Getting list of unique keys
fao_eez <-  fao_eez_keys |> 
  select(!ID_mrgd) |> 
  distinct()

bio_data <- bio_data |> 
  #Add reference period to yearly biomass data
  left_join(ref_bio, by = c("mem", "esm", "fao_official")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate mean and standard deviation for percentage change 
  #per year(scenario)/region
  group_by(year, scenario, fao_official) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T)) |> 
  #Add names in FAO-EEZ keys
  left_join(fao_eez, by = "fao_official") |> 
  ungroup()

#Check results
bio_data
```
  
We can now save the results for future reference.  
  
```{r}
#Create name to save file  
f_out <- file.path(out_folder, "ensemble_perc_bio_change_data.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)
```
  
## Defining basic plot design
  
```{r}
base_gg <- list(geom_line(linewidth = 0.5),
                #Adding no change line at 0 for reference 
                geom_hline(yintercept = 0, color = "#709fcc", linewidth = 0.65, 
                           linetype = 2),
                #Adding line dividing historical period and future projections
                geom_vline(xintercept = 2015, color = "#709fcc", 
                           linewidth = 0.65),
                #Adding SD as shading 
                geom_ribbon(aes(ymin = mean_change-sd_change,
                                ymax = mean_change+sd_change, fill = scenario),
                            alpha = 0.3, color = NA),
                #Manually setting colours to be used in plots
                scale_color_manual(values = c("historical" = "black",
                                              "ssp126" = "#33bbee", 
                                              "ssp585" = "#ee3377"), 
                                   name = "Scenarios",
                                   labels = c("Historical", "SSP1-2.6", 
                                              "SSP5-8.5")),
                scale_fill_manual(values = c("historical" = "black", 
                                             "ssp126" = "#33bbee", 
                                             "ssp585" = "#ee3377"), 
                                  name = "Scenarios",
                                  labels = c("Historical", "SSP1-2.6", 
                                             "SSP5-8.5")),
                guides(color = guide_legend(nrow = 1, title.position = "left")),
                theme_bw(),
                labs(y = "Change in exploitable\nfish biomass (%)"),
                theme(legend.position = "top", legend.justification = "center", 
                      legend.text = element_text(size = 10),
                      panel.grid.minor.y = element_blank(), 
                      axis.title.x = element_blank(),
                      axis.title.y = element_text(size = 12),
                      axis.text.x = element_text(angle = 45, vjust = 0.765, 
                                                 hjust = 0.65)))
```

  
## Figure 1 - Trends globally and for top 7 countries with highest catches
Note that data used here correspond to EEZs linked to each country main landmass where areas are not disputed. Overseas territories and disputed areas are not included here.  

### Calculating global trends
  
```{r eval = F}
#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Apply mask
    left_join(area_grid, by = join_by(x, y)) |> 
    #Removing areas not recognised in FAO official name list
    drop_na(fao_official) |> 
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario) |> 
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))
  
  #Create name to save file  
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_global_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
Now we can calculate the global trends.  
  
```{r eval = F}
#Listing all relevant files to calculate biomass projections
global_data <- list.files(out_folder, pattern = "_yearly_global_perc_bio_change_data.csv",
                       full.names = T) |> 
  map_df(~fread(.))

#Calculating global reference period
global_ref_bio <- global_data |> 
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per ensemble member
  group_by(mem, esm) |> 
  summarise(ref_bio = mean(mean_bio, na.rm = T))

global_data <- global_data |> 
  #Add reference period to yearly biomass data
  left_join(global_ref_bio, ref_bio, by = c("mem", "esm")) |> 
  #Calculate percentage change per model/year(scenario)
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate annual mean and standard deviation for percentage change 
  group_by(year, scenario) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Check results
global_data
```
  
### Calculating trends for top 7 countries
  
```{r}
#Defining top 7 countries by catch
top_7 <- c("Republic of China", "India", "Indonesia", "Peru", "Russian", 
           "United States", "Viet")

#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Apply mask
    left_join(area_grid, by = join_by(x, y)) |> 
    #Select top 7 producers
    filter(str_detect(Official_Name_En_Stefania_NEW, 
                      paste0(top_7, collapse = "|"))) |>
    mutate(Official_Name_En_Stefania_NEW = case_when(str_detect(Official_Name_En_Stefania_NEW, 
                                                      "United States") ~ "the United States of America",
                                                     T ~ Official_Name_En_Stefania_NEW)) |> 
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario, Official_Name_En_Stefania_NEW) |> 
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))
  
  #Create name to save file  
  f_out <- file.path(out_folder, 
                     str_c(m, "_yearly_top7_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
Now we can calculate the trends for top 7 countries.  
  
```{r}
#Listing all relevant files to calculate biomass projections
top7_data <- list.files(out_folder, 
                        pattern = "_yearly_top7_perc_bio_change_data.csv",
                       full.names = T) |> 
  map_df(~fread(.))

#Calculating top 7 reference period
top7_ref_bio <- top7_data |> 
  #Select reference period
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per country
  group_by(mem, esm, SOVEREIGN1) |> 
  summarise(ref_bio = mean(mean_bio, na.rm = T))

top7_base_data <- top7_data |> 
  #Add reference period to yearly biomass data
  left_join(top7_ref_bio, by = c("mem", "esm", "SOVEREIGN1")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate mean and standard deviation for percentage change 
  #per year(scenario)/region
  group_by(year, scenario, SOVEREIGN1) |> 
  summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T)) |> 
  ungroup()
```
  
### Plotting trends globally and for top 7 countries
  
```{r}
#Merging global and top 7 countries data
global_data |> 
  #Add an extra column to match top 7 countries
  mutate(SOVEREIGN1 = "Global") |> 
  relocate(SOVEREIGN1, .after = "scenario") |> 
  #Joining to top7 data
  bind_rows(top7_base_data) |> 
  #Create an order category for SOVEREIGN1
  mutate(SOVEREIGN1 = factor(SOVEREIGN1, 
                             levels = c("Global", 
                                        unique(top7_base_data$SOVEREIGN1)), 
                             ordered = T)) |> 
  #Plotting
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  #Applying base plot design
  base_gg+
  #Plotting by country
  facet_wrap(~SOVEREIGN1, scales = "free_y", nrow = 8)
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "top_7_global_trends.pdf"),
       device = "pdf", width = 6, height = 12)
```
  
## Figure 2 - Asia
In this figure, we will exclude any EEZs were overlapping claims have been reported as per the [EEZ shapefile version 11](https://doi.org/10.14284/386). Jointly managed areas were kept and are clearly labelled.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in Asia, but with NO overlapping claims
  filter(region == "Asia" & str_detect(nm_mrgd, "Overlapping|Joint", negate = T)) |>
  #Shorten Exclusive Economic Zone to EEZ
  mutate(nm_mrgd = str_replace(nm_mrgd, "Exclusive.*one", "EEZ")) |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(30)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "asia_perc_change.pdf"),
       device = "pdf", width = 10, height = 14.35)
```
  
## Figure 3 - Africa
In this figure, we will exclude any EEZs were overlapping claims have been reported as per the [EEZ shapefile version 11](https://doi.org/10.14284/386). French and British overseas territories were also removed from this figure. Jointly managed areas were kept and are clearly labelled.  
  
```{r}
#Filtering data
bio_data |> 
  #African EEZs, excluding areas with overlapping claims
  filter(region == "Africa" & str_detect(nm_mrgd, "Overlapping|Joint", negate = T) &
           #Excluding French and Bristish territories
           !SOVEREIGN1 %in% c("France", "United Kingdom")) |> 
  mutate(nm_mrgd = str_replace(nm_mrgd, "Exclusive.*one", "EEZ")) |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5, 
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(20)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "africa_perc_change.pdf"),
       device = "pdf", width = 10, height = 14.35)
```
  
## Figure 4 - Europe
In this figure, we will exclude any EEZs were overlapping claims have been reported as per the [EEZ shapefile version 11](https://doi.org/10.14284/386). Clipperton, a French overseas territory, has been excluded because the island is geographically located in the Americas. Jointly managed areas were kept and are clearly labelled.  
  
```{r}
#Filtering data
bio_data |> 
  filter(region == "Europe" & str_detect(nm_mrgd, "Overlapping|Clipperton|Joint", 
                                         negate = T)) |> 
  mutate(nm_mrgd = str_replace(nm_mrgd, "Exclusive.*one", "EEZ")) |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(30)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "europe_perc_change.pdf"),
       device = "pdf", width = 12, height = 16)
```
  
## Figure 5 - Americas
In this figure, we will exclude any EEZs were overlapping claims have been reported as per the [EEZ shapefile version 11](https://doi.org/10.14284/386). Overseas territories from Denmark, France, the Netherlands and the United Kingdom. Jointly managed areas were kept and are clearly labelled.  
  
```{r}
#Filtering data
bio_data |> 
  filter(str_detect(region, "America") & str_detect(nm_mrgd, 
                                                    "Overlapping|Joint", 
                                                    negate = T)
         & str_detect(SOVEREIGN1, "Denmark|France|Netherlands|Kingdom", 
                      negate = T)) |>
  mutate(nm_mrgd = str_replace(nm_mrgd, "Exclusive.*one", "EEZ")) |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(30)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "americas_perc_change.pdf"),
       device = "pdf", width = 12, height = 17.22)
```
  
## Figure 6 - Oceania
In this figure, we will exclude overseas territories for France, United States and United Kingdom. Jointly managed areas were kept and are clearly labelled.  
  
```{r}
#Filtering data
bio_data |> 
  filter(region == "Oceania" & 
           str_detect(SOVEREIGN1, "France|United", negate = T) & 
           str_detect(nm_mrgd, "Protected", negate = T)) |> 
  mutate(nm_mrgd = str_replace(nm_mrgd, "Exclusive.*one", "EEZ")) |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(20)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "oceania_perc_change.pdf"),
       device = "pdf", width = 10, height = 9)
```
  
## Figure 7 - FAO regions
  
```{r}
#Filtering data
bio_data |> 
  #Removing EEZs
  drop_na(OCEAN) |> 
  #Plotting data
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by FAO sector
  facet_wrap(~nm_mrgd, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(nm_mrgd = label_wrap_gen(30)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "fao_regions_perc_change.pdf"),
       device = "pdf", width = 10, height = 6)
```
  

  