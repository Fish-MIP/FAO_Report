---
title: "Temporal biomass change"
author: "Denisse Fierro Arcos"
date: "2024-01-17"
output: pdf_document
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
library(data.table)
#Raster data
library(terra)
#Combining plots
library(cowplot)
```

## Setting up notebook
This notebook uses a modified version of the Exclusive Economic Zones boundaries (version 11) from the [Flanders Marine Institute (2019)](https://doi.org/10.14284/386). Available [online](https://www.marineregions.org/). The following modifications were made:  
- Boundaries for South Georgia and Sandwich Islands were updated to boundaries provided by the UN  
- Boundaries around Bouvet Island (Norway) in the south Atlantic were added to this shapefile  
- Country boundaries were dissolved and polygons were reclassified by continent  
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}
```
  
## Getting area of grid cells for IPSL and GFDL
  
```{r}
#Location of area grid files
area_grid <- "/rd/gem/private/shared_resources/grid_cell_area_ESMs/isimip3b/"

#Getting GFDL grid area
area_gfdl <- rast(list.files(area_grid, "gfdl", full.names = T))
#Change land values from 0 to NA
area_gfdl[area_gfdl == 0] <- NA
#Transform to data frame
area_gfdl_df <- area_gfdl |> 
  as.data.frame(xy = T)

#Getting IPSL grid area
area_ipsl <- rast(list.files(area_grid, "ipsl", full.names = T))
# plot(area_ipsl) # lake values in file but have been deleted from models so OK 
#Transform to data frame
area_ipsl_df <- area_ipsl |> 
  as.data.frame(xy = T)
```


```{r}
#EEZ keys
eez_keys <- read_csv("data/eez_keys_camilla.csv")

filter(eez_keys, fao_official == "Australia") # 2 different id_merge (one for AU and the other for Macquarie island). Extraction of data by country through lat and lon will be done using id_mrq (eez specific) but grouping to calculate mean biomass will be done using fao_official (fao_country specific) so that both Au and mq island will fall under Au as per fao_official

#FAO keys
fao <- read_csv(list.files(out_folder, 
                           pattern = "FAO_MajorAreas_200NM_cont_keys.csv", 
                           full.names = T, recursive = T)) |> 
  #Keep FAO areas only
  drop_na(OCEAN) |> 
  #Removing duplicates
  distinct() |> 
  #Keep relevant columns only
  select(ID_mrgd, OCEAN, NAME_EN)

#Merging FAO and EEZ keys
fao_eez_keys <- fao |>
  bind_rows(eez_keys) |> 
  #Keep all official names in a single column for FAO and EEZ areas
  mutate(fao_official = case_when(is.na(fao_official) ~ NAME_EN, 
                                  T ~ fao_official)) |> 
  #Remove duplicate column
  select(!NAME_EN)
  
#Removing individual keys
rm(eez_keys, fao)

#FAO_EEZ mask - Contains IDs for FAO and EEZ areas
fao_eez_mask <- list.files(out_folder, 
                           pattern = "FAO_Major_200NM_masked_area_1deg.csv",
                           full.names = T, recursive = T) |> 
  read_csv() |> 
  #Renaming ID column
  dplyr::rename("ID_mrgd" = "mask") |> 
  #Adding official names to be used in plots
  left_join(fao_eez_keys[,c("ID_mrgd", "fao_official")], 
            by = join_by(ID_mrgd))

#Merging masks and area files into a single variable
fao_eez_mask <- fao_eez_mask |> 
  left_join(area_gfdl_df, by = join_by("x", "y")) |> 
  rename(gfdl = areacello) |> 
  left_join(area_ipsl_df, by = join_by("x", "y")) |> 
  rename(ipsl = cell_area)

#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()

```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- fao_eez_mask |> 
      select(!gfdl) |> 
      #rename column
      rename(area_m = ipsl)
  }else if(str_detect(m, "gfdl")){
    area_grid <- fao_eez_mask |> 
      select(!ipsl)|> 
      #rename column
      rename(area_m = gfdl)
  }
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and area ID (FAO and EEZ)
    left_join(area_grid, by = join_by(x, y)) |>
    #Removing areas not recognised in FAO official name list
    drop_na(fao_official) |>
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario, fao_official) |> 
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))
  
  #Create name to save file
  f_out <- file.path(out_folder, str_c(m, "_yearly_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}
```
  
## Calculating mean for reference period
Plots created here will show percentage change in biomass over time under two emissions scenarios: `SSP1-2.6` and `SSP5-8.5`. Our reference period is 2005-2014.  
  
```{r eval = F}
#Listing all relevant files to calculate biomass projections
bio_data <- list.files(out_folder, 
                       pattern = "_yearly_perc_bio_change_data.csv",
                       full.names = T) |> 
  map_df(~fread(.))

# CN check NAs by model 
a<-filter(bio_data, is.na(mean_bio)) # lots of NAs!!! this time not only for gfdl but for ipsl too!!!
unique(a$fao_official) 

# [1] "Turkmenistan"                    "the Hashemite Kingdom of Jordan" "the Kingdom of Bahrain"         
# [4] "the Republic of Albania"         "the Republic of Azerbaijan"      "the Republic of Djibouti"       
# [7] "the Republic of Iraq"            "the Republic of Kazakhstan"      "the Republic of the Sudan"      
# [10] "the State of Kuwait"             "the Kingdom of Belgium"          "the Republic of Cameroon"  
 
a<-filter(bio_data, fao_official == "Turkmenistan", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only models with caspian sea have this trend

# (almost landlock - should remove?) 
a<-filter(bio_data, fao_official == "the Hashemite Kingdom of Jordan", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (but boats)

a<-filter(bio_data, fao_official == "the Kingdom of Bahrain"  , !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (including boats)

a<-filter(bio_data, fao_official == "the Republic of Albania", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (but boats)

a<-filter(bio_data, fao_official == "the Republic of Azerbaijan", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (including boats)

a<-filter(bio_data, fao_official == "the Republic of Djibouti", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (including boats)

a<-filter(bio_data, fao_official == "the Republic of Iraq" , !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (but boats)

a<-filter(bio_data, fao_official == "the Republic of Kazakhstan", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only models with caspian sea have this trend

a<-filter(bio_data, fao_official == "the Republic of the Sudan", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (including boats)

a<-filter(bio_data, fao_official == "the State of Kuwait", !is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # only gfdl model have these info (including boats)

a<-filter(bio_data, fao_official == "the Kingdom of Belgium", is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # boats does not have this info - not sure why

a<-filter(bio_data, fao_official == "the Republic of Cameroon", is.na(mean_bio))
a$id<-paste(a$esm, a$mem)
unique(a$id) # boats does not have this info - not sure why

#Calculating reference period
ref_bio <- bio_data |> 
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per ensemble member
  group_by(mem, esm, fao_official) |> 
  dplyr::summarise(ref_bio = mean(mean_bio, na.rm = T))

# #Getting list of unique keys # this is needed to add ocean and continent information. but first you need to solve the problem with same fao_official aand different ID_mrg. 
# filter(fao_eez_keys, fao_official == "Australia") # check repetitions 
# fao_eez_trial<-split(fao_eez_keys, fao_eez_keys$fao_official)
# which(lapply(fao_eez_trial, function(x) nrow(x))>1)
# fao_eez_trial[6]

# some are repetition if ID_mgr is removed 
fao_eez <-  fao_eez_keys |>
  select(!ID_mrgd) |>
  distinct()
# nrow(fao_eez)

# other are not because caountry_FAO is different. 
# fao_eez_trial[14]
# to_remove<-fao_eez %>% 
#   filter(!is.na(continent) & is.na(Country_FAO)) 
# nrow(to_remove)

fao_eez<-fao_eez %>% 
  filter((is.na(continent) & is.na(Country_FAO))|(!is.na(continent) & !is.na(Country_FAO))) 
# nrow(fao_eez)

# calculate trends by model as neded for stat table 
bio_data_by_model <- bio_data |> 
  #Add reference period to yearly biomass data
  left_join(ref_bio, by = c("mem", "esm", "fao_official")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) %>% 
  select(-mean_bio, -ref_bio) %>% 
  #Add names in FAO-EEZ keys
  left_join(fao_eez, by = "fao_official") 

#Check results
bio_data_by_model

bio_data <- bio_data |> 
  #Add reference period to yearly biomass data
  left_join(ref_bio, by = c("mem", "esm", "fao_official")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate mean and standard deviation for percentage change 
  #per year(scenario)/region
  group_by(year, scenario, fao_official) |> 
  dplyr::summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T)) |> 
  #Add names in FAO-EEZ keys
  left_join(fao_eez, by = "fao_official") |> 
  ungroup()

#Check results
bio_data

```
  
We can now save the results for future reference.  
  
```{r}
#Create name to save file
f_out <- file.path(out_folder, "ensemble_perc_bio_change_data.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

#Create name to save file
f_out <- file.path(out_folder, "mem_perc_bio_change_data.csv")

#Saving results for each model
bio_data_by_model |>
  write_csv(f_out)

```
  
## Defining basic plot design
  
```{r}
base_gg <- list(geom_line(linewidth = 0.5),
                #Adding no change line at 0 for reference 
                geom_hline(yintercept = 0, color = "#709fcc", linewidth = 0.65, 
                           linetype = 2),
                #Adding line dividing historical period and future projections
                geom_vline(xintercept = 2015, color = "#709fcc", 
                           linewidth = 0.65),
                #Adding SD as shading 
                geom_ribbon(aes(ymin = mean_change-sd_change,
                                ymax = mean_change+sd_change, fill = scenario),
                            alpha = 0.3, color = NA),
                #Manually setting colours to be used in plots
                scale_color_manual(values = c("historical" = "black",
                                              "ssp126" = "#33bbee", 
                                              "ssp585" = "#ee3377"), 
                                   name = "Scenarios",
                                   labels = c("Historical", "SSP1-2.6", 
                                              "SSP5-8.5")),
                scale_fill_manual(values = c("historical" = "black", 
                                             "ssp126" = "#33bbee", 
                                             "ssp585" = "#ee3377"), 
                                  name = "Scenarios",
                                  labels = c("Historical", "SSP1-2.6", 
                                             "SSP5-8.5")),
                guides(color = guide_legend(nrow = 1, title.position = "left")),
                theme_bw(),
                labs(y = "Change in exploitable\nfish biomass (%)"),
                theme(legend.position = "top", legend.justification = "center", 
                      legend.text = element_text(size = 10),
                      panel.grid.minor.y = element_blank(), 
                      axis.title.x = element_blank(),
                      axis.title.y = element_text(size = 12),
                      axis.text.x = element_text(angle = 45, vjust = 0.765, 
                                                 hjust = 0.65)))
```

  
## Figure 1 - Trends globally and for top 7 countries with highest catches
Note that data used here correspond to EEZs linked to each country main landmass where areas are not disputed. Overseas territories and disputed areas are not included here. This means that high seas (i.e., areas beyond a country's jurisdiction) were not included in this calculation.  

### Calculating global trends
  
```{r eval = F}
#Looping through each FishMIP model
for(m in members){
  
  # m = "boats_gfdl"
  
  # CN adding selection of area_gridcell here too 
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- fao_eez_mask |> 
      select(!gfdl) |> 
      #rename column
      rename(area_m = ipsl)
  }else if(str_detect(m, "gfdl")){
    area_grid <- fao_eez_mask |> 
      select(!ipsl)|> 
      #rename column
      rename(area_m = gfdl)
  }
  
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Apply mask
    left_join(area_grid, by = join_by(x, y)) |>
    #Removing areas not recognised in FAO official name list
    drop_na(fao_official) |>
    #Removing FAO Major Areas (2 digit numbers) instead of 4-5 digits for EEZs
    filter(ID_mrgd > 999) |>
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario) |>
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))

  #Create name to save file
  f_out <- file.path(out_folder,
                     str_c(m, "_yearly_global_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}

```
  
Now we can calculate the percentage change in global exploitable fish biomass.  
  
```{r eval = F}

# Listing all relevant files to calculate biomass projections
global_data <- list.files(out_folder, 
                          pattern = "_yearly_global_perc_bio_change_data.csv",
                          full.names = T) |> 
  map_df(~fread(.))

# CN check NAs for some models 
a<-filter(global_data, is.na(mean_bio))
a$id<-paste(a$mem, a$esm)
unique(a$id)
# all the gfdl files are empty! 
filter(global_data, mem == "boats", esm == "gfdl")

## RERUNNING the above loop (withing the loop now everything works). OK no NAs. Plot changed - smaller sd. 

# Calculating global reference period
global_ref_bio <- global_data |> 
  filter(year >= 2005 & year <= 2014) |> 
  # Calculate mean per ensemble member
  group_by(mem, esm) |> 
  dplyr::summarise(ref_bio = mean(mean_bio, na.rm = T))

# calculate change by model 
global_data_by_model <- global_data |> 
  #Add reference period to yearly biomass data
  left_join(global_ref_bio, ref_bio, by = c("mem", "esm")) |> 
  #Calculate percentage change per model/year(scenario)
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  select(-mean_bio, -ref_bio)

#Check results
global_data_by_model

global_data <- global_data |> 
  #Add reference period to yearly biomass data
  left_join(global_ref_bio, ref_bio, by = c("mem", "esm")) |> 
  #Calculate percentage change per model/year(scenario)
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate annual mean and standard deviation for percentage change 
  group_by(year, scenario) |> 
  dplyr::summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T))

#Check results
global_data

```
  
### Calculating trends for top 7 countries
The top 7 countries by fishing catches are China (including Taiwan), India, Indonesia, Peru, Russia, United States and Viet Nam. Note that all marine areas identified to be under the jurisdiction of these countries were included in the calculation of trends.  
  
```{r}

#Defining top 7 countries by catch
top_7 <- c("China", "India", "Indonesia", "Peru", "Russian", "United States",
           "Viet")

#Identifying areas to keep from the FAO_EEZ keys
keys_top7 <- fao_eez_keys |> 
  #Keep only top 7 fishing countries
  dplyr::filter(str_detect(Country_FAO, paste0(top_7, collapse = "|"))) |> 
  #Drop columns that are not relevant
  select(continent:fao_official) |> 
  distinct()

#Looping through each FishMIP model
for(m in members){
  
  # adding this here too 
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- fao_eez_mask |> 
      select(!gfdl) |> 
      #rename column
      rename(area_m = ipsl)
  }else if(str_detect(m, "gfdl")){
    area_grid <- fao_eez_mask |> 
      select(!ipsl)|> 
      #rename column
      rename(area_m = gfdl)
  }
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Apply mask
    left_join(area_grid, by = join_by(x, y)) |>
    #Select top 7 producers
    filter(fao_official %in% keys_top7$fao_official) |>
    #Add names in top 7 keys
    left_join(keys_top7, by = "fao_official") |>
    #Keep same name for all EEZ that for part of China and the US
    mutate(fao_official = case_when(str_detect(Country_FAO, "United") ~
                                     "the United States of America",
                                   Country_FAO == "China" ~
                                     "the People's Republic of China",
                                   T ~ fao_official)) |>
    
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario, fao_official) |>
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T))

  #Create name to save file
  f_out <- file.path(out_folder,
                     str_c(m, "_yearly_top7_perc_bio_change_data.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}

```
  
Now we can calculate the percentage change in exploitable fish biomass from the reference period (2005-2014) for the top 7 countries by fisheries catches.  
  
```{r}
#Listing all relevant files to calculate biomass projections
top7_data <- list.files(out_folder, 
                        pattern = "_yearly_top7_perc_bio_change_data.csv",
                       full.names = T) |> 
  map_df(~fread(.))

# check NAs for some models 
a<-filter(top7_data, is.na(mean_bio)) 
a$id<-paste(a$mem, a$esm)

# The gfdl files are empty for some countries - all countries are effected. 

filter(top7_data, mem == "boats", esm == "gfdl")
#   year   mem  esm   scenario                       fao_official   mean_bio
# 1: 1950 boats gfdl historical     the People's Republic of China        NA
# 2: 1950 boats gfdl historical              the Republic of India  8.688628
# 3: 1950 boats gfdl historical          the Republic of Indonesia        NA
# 4: 1950 boats gfdl historical               the Republic of Peru 76.873429
# 5: 1950 boats gfdl historical             the Russian Federation        NA

filter(top7_data, mem == "macroecological", esm == "gfdl")
#  year             mem  esm   scenario                       fao_official mean_bio
# 1: 1950 macroecological gfdl historical     the People's Republic of China       NA
# 2: 1950 macroecological gfdl historical              the Republic of India       NA
# 3: 1950 macroecological gfdl historical          the Republic of Indonesia       NA
# 4: 1950 macroecological gfdl historical               the Republic of Peru       NA
# 5: 1950 macroecological gfdl historical             the Russian Federation       NA

# RERUNNING code - all good now 

# Calculating top 7 reference period
top7_ref_bio <- top7_data |> 
  #Select reference period
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per country
  group_by(mem, esm, fao_official) |> 
  dplyr::summarise(ref_bio = mean(mean_bio, na.rm = T))

filter(top7_ref_bio, is.na(ref_bio))

# calculate change by model 
top7_base_data_by_model <- top7_data |> 
  #Add reference period to yearly biomass data
  left_join(top7_ref_bio, by = c("mem", "esm", "fao_official")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  select(-mean_bio, -ref_bio)

#Check results
top7_base_data_by_model

top7_base_data <- top7_data |> 
  #Add reference period to yearly biomass data
  left_join(top7_ref_bio, by = c("mem", "esm", "fao_official")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate mean and standard deviation for percentage change 
  #per year(scenario)/region
  group_by(year, scenario, fao_official) |> 
  dplyr::summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T)) |> 
  ungroup()
```
  
## Table of stats, model agreement and wilcox.test   

```{r}

# Impacts of climate change report: Table 4.1. projected change in catch potential (%) by 2050 and 2100 relative to 2000 under the RCP2.6 and RCP8.5 based on outputs from the dynamic bioclimate envelope model. The table show the average change per EEZ, as well as the variability (range) around the average, representing the different estimates from the array of climate models used to drive the fisheries projections. Table 4.2 is the same but for DBPM. 

# need to use global_data_by_model, top7_base_data_by_model, bio_data_by_model to calculate: 

# mean, median and sd across models and last decade, for 2050 & 2100 
# min and max values across models and using decade average of % changes, for 2050 & 2100 
# model agreement in the direction of change (percentage of models having the same direction of change), across models and using decade average of % changes, for 2050 & 2100 
# stat test on difference between scenarios  

### merge all info ----
global_data_by_model<-global_data_by_model %>% 
  mutate(fao_official = "global", 
         spatial_scale = "global")
  
top7_base_data_by_model<-top7_base_data_by_model %>% 
  mutate(spatial_scale = "top_7_countries")

bio_data_by_model<-bio_data_by_model %>% 
  mutate(spatial_scale = ifelse(is.na(OCEAN),"countries","FAO_area"))

all_scale_data_by_model<-global_data_by_model %>% 
  full_join(top7_base_data_by_model) %>% 
  full_join(bio_data_by_model) %>% 
  filter(year %in% c(2041:2050, 2091:2100)) %>% 
  mutate(decade = ifelse(year %in% c(2041:2050), "2041-2050", "2091-2100")) %>% 
  filter(!is.na(perc_change)) # this is important as some models do not output info on these countries (e.g. the Kingdom of Bahrain as explored above in country section). CHECK if these countries are giving expected results in terms of e.g. agreement. 

filter(all_scale_data_by_model, fao_official == "the Kingdom of Bahrain")

### mean, media, sd, min and max ----
# Is this OK or variability in time confounds across-model uncertainty as for spatial variability in maps??? Should I calculate sd only after having averaged across years of the same decade for each model??? mean and median should be the same.  
stats<-all_scale_data_by_model %>% 
  group_by(fao_official, scenario, decade, spatial_scale) %>% 
  summarise(mean = mean(perc_change), # across both decade and model
            sd = sd(perc_change),
            median = median(perc_change)) %>%  
  ungroup() 

agreement<-all_scale_data_by_model %>% 
  group_by(fao_official, mem, esm, scenario, decade, spatial_scale) %>% 
  summarise(mean = mean(perc_change, na.rm = T)) %>%  # across decade only to have one (mean) value of change per model 
  ungroup() %>% 
  group_by(fao_official, scenario, decade, spatial_scale) %>% 
  summarise(min = min(mean), # then across model 
            max = max(mean),
            n_model = n(), # to calculate agreement again across models
            n_positive = sum(mean>0),
            n_negative = sum(mean<0), 
            same_sign = max(n_positive,n_negative),
            agreement = (same_sign/n_model)*100)
# check 
filter(agreement, fao_official == "the Republic of Albania")

agreement<-agreement %>% 
  select(-c(n_model, n_positive, n_negative, same_sign))
  
table<-stats %>% 
  full_join(agreement)

# # test on momdel agreement
# data.frame(n_model = 10, 
#            n_positive = 5, 
#            n_negative = 5) %>% 
#   mutate(same_sign = max(n_positive, n_negative),
#          agreement = (same_sign/n_model)*100)
# 
# # check by plotting considering top 7 countries
# to_plot<-top7_base_data_by_model %>% 
#   filter(year %in% c(2041:2050), 
#          scenario == "ssp126") %>% 
#   mutate(id = paste(esm, mem, sep ="_"))
# 
# ggplot(to_plot, aes(x = year, y = perc_change, group = id, color = id))+
#   geom_line()+ 
#   geom_hline(yintercept = 0, color = "black")+
#   facet_wrap(~fao_official)

#### stat test ----
# Are the changes under the different scenarios significantly different? is the median of percentage change under ssp126 different from the median of per change under ssp585? 

# http://www.sthda.com/english/wiki/unpaired-two-samples-wilcoxon-test-in-r
# from example: 
# The p-value of the test is 0.02712, which is less than the significance level alpha = 0.05. We can conclude that men’s median weight is significantly different from women’s median weight with a p-value = 0.02712.

w_test<-all_scale_data_by_model %>% 
  spread(scenario, perc_change) %>% 
  group_by(fao_official, decade, spatial_scale) %>%
  summarise(wilcox_p = wilcox.test(ssp126, ssp585, alternative = "two.sided")$p.value) %>% 
  ungroup()

table<-table %>% 
  full_join(w_test)

# # check warnings 
# dplyr::last_dplyr_warnings()
# filter(w_test, fao_official == "the Kingdom of Bahrain", decade == "2041-2050", spatial_scale == "countries") # values are provided but might not be trustable is my interpretation. 
# 
# # check single test 
# w_test_warnings<-all_scale_data_by_model %>% 
#   spread(scenario, perc_change) %>% 
#   filter(fao_official == "the Kingdom of Bahrain",
#          decade == "2041-2050",
#          spatial_scale == "countries") 
# 
# wilcox.test(w_test_warnings$ssp126, w_test_warnings$ssp585, alternative = "two.sided")$p.value
# # where ties is when both set have the same value. 
# 
# # test if values are correct according to below 
# # check if values are the same with below test - yes 
# filter(w_test, fao_official == "the Socialist Republic of Viet Nam")
# 
# # test to understand wilcox - STILL NEED TO CHECK AS NOT WELL UNDERSTOOD
# # between scenarios in 2050 - row values 
# trial<-top7_base_data_by_model %>% 
#   filter(fao_official == "the Socialist Republic of Viet Nam", 
#          year >= 2041 & year <= 2050) 
# 
# # boxplot 
# ggplot(trial, aes(x=scenario, y=perc_change)) +
#     geom_boxplot() +
#     geom_jitter(color="black", size=0.4, alpha=0.9) 
# 
# trial_test<-trial %>% 
#   spread(scenario, perc_change) 
# 
# wilcox.test(trial_test$ssp126, trial_test$ssp585, alternative = "two.sided")$p.value # 0.0590907 not significant
#     
# # between scenarios in 2100 - row values 
# trial<-top7_base_data_by_model %>% 
#   filter(fao_official == "the Socialist Republic of Viet Nam", 
#          year >= 2091 & year <= 2100) 
# 
# # boxplot 
# ggplot(trial, aes(x=scenario, y=perc_change)) +
#     geom_boxplot() +
#     geom_jitter(color="black", size=0.4, alpha=0.9) 
# 
# trial_test<-trial %>% 
#   spread(scenario, perc_change) 
# 
# wilcox.test(trial3_test$ssp126, trial3_test$ssp585, alternative = "two.sided")$p.value # 1.967129e-20 with raw values this is very significant which is a bit strange given sd of values overlap in trend figure...
# 
# # calculate mean and sd across modes by year 
# trial %>% group_by(year, scenario) %>% summarise(mean = mean(perc_change), sd = sd(perc_change))
# # compare to values in already calcualted ternds - yes they are the same 
# filter(top7_base_data, year >= 2091, fao_official == "the Socialist Republic of Viet Nam") 
# 
# ggplot(trial %>% group_by(year, scenario) %>% summarise(mean = mean(perc_change), sd = sd(perc_change)), aes(x = year, y = mean, group = scenario))+
#   geom_line() # TO DO: add ssd and add box plot for each year to see what the difference is... 

# could calculate all of the above but using only the year 2050 and 2100 - simpler...

# table_global<-global_data %>%
#   filter(year %in% c(2050, 2100)) %>%
#   select(-sd_change) %>%
#   arrange(scenario, year) %>%
#   relocate(scenario, year, mean_change)
# 
# table_top7<-top7_base_data %>%
#   filter(year %in% c(2050, 2100)) %>%
#   select(-sd_change) %>%
#   arrange(fao_official, scenario, year) %>%
#   relocate(fao_official, scenario, year, mean_change)
# 
# table_countries<-bio_data %>%
#   filter(year %in% c(2050, 2100)) %>%
#   select(-c(Country_FAO, sd_change)) %>%
#   arrange(continent, fao_official, scenario, year) %>%
#   relocate(continent, OCEAN, fao_official, scenario, year, mean_change)
#
# # print - change location of files as no access to terminal right now 
# fwrite(table_global, paste0(out_folder,"/table_global.csv"))
# fwrite(table_top7, paste0(out_folder,"/table_top7.csv"))
# fwrite(table_countries, paste0(out_folder,"/table_countries.csv"))

fwrite(table, "data/data_products/table_stats.csv")

```

## Plotting trends for FishMIP Ocean Decede Conference 

```{r}

# copy-paste from above
ODCdata<-global_data |>
  #Add an extra column to match top 7 countries
  mutate(fao_official = "Global", .after = "scenario") |>
  #Joining to top7 data
  bind_rows(top7_base_data) |>
  #Create an order category for SOVEREIGN1
  mutate(fao_official = factor(fao_official,
                               levels = c("Global",
                                          unique(top7_base_data$fao_official)),
                             ordered = T))

globe<-ggplot(filter(ODCdata, fao_official == "Global"), aes(x = year, y = mean_change, colour = scenario))+
  #Applying base plot design
  base_gg

# ggsave(filename = "figures/global_trends_ODC.pdf",
#        device = "pdf", width = 5, height = 3.5)

# png("figures/global_trends_ODC.png", width=5, height=3.5, units="in", res=1200)
# globe
# dev.off()

top6<-ggplot(filter(ODCdata, !fao_official %in% c("Global", "the United States of America")), aes(x = year, y = mean_change, colour = scenario))+
  #Applying base plot design
  base_gg+
  facet_wrap(~fao_official, scales = "free_y", nrow = 2,
             labeller = labeller(fao_official = label_wrap_gen(40)))

# ggsave(filename = "figures/top_6_global_trends_ODC.pdf",
#        device = "pdf", width = 8, height = 4)

# png("figures/top_6_global_trends_ODC.png", width=8, height=4, units="in",res=1200)
# top6
# dev.off()

### plot error bars 

## use decade and mean and sd across decade and models - could also plot histograms instead of data point. Is this OK or variability in time confounds across-model uncertainty as for spatial variability in maps??? Should I calculate sd only after having averaged across years of the same decade for each model??? 

bio_dataOCD<-all_scale_data_by_model %>% 
  filter(!is.na(OCEAN)) %>% 
  group_by(fao_official, scenario, decade) %>% # this is like the stat dataset above
  summarise(mean = mean(perc_change), # across both decade and model
            sd = sd(perc_change),
            median = median(perc_change)) %>%  
  ungroup() 

# order values
sorting<-bio_dataOCD %>% 
  filter(scenario == "ssp585", decade == "2091-2100") %>% 
  arrange(-mean)

trial<-unique(sorting$fao_official)
trial<-factor(trial, levels=unique(trial))

bio_dataOCD <-bio_dataOCD %>% 
  mutate(fao_official = factor(fao_official, levels = trial))

uncert_decade<-ggplot(filter(bio_dataOCD, fao_official != "Arctic Sea"), aes(x=fao_official, y=mean, group=scenario, color=scenario)) + 
  geom_point()+ 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                position=position_dodge(0.05))+
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", linewidth = 1)+
  scale_color_manual(name = "Scenario", labels = c("SSP1-2.6", "SSP5-8.5"), values=c("#33bbee", "#ee3377"))+
  labs(x="FAO Major Fishing Area", y = "Change in exploitable fish biomass (%)") +
  coord_flip()+
  theme(axis.text=element_text(size=14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title=element_text(size=14)) + # face = "bold"
  facet_wrap(~decade)

png("figures/FAOarea_uncertity_decade.png", width=10, height=5, units="in",res=1200)
uncert_decade
dev.off()

# use year 
bio_dataOCD<-bio_data %>% 
  filter(!is.na(OCEAN),
         year %in% c(2050, 2100)) 

sorting<-bio_dataOCD %>% 
  filter(scenario == "ssp585", year == 2100) %>% 
  arrange(-mean_change)

trial<-unique(sorting$fao_official)
trial<-factor(trial, levels=unique(trial))

bio_dataOCD<-bio_dataOCD %>% 
  mutate(fao_official = factor(fao_official, levels = trial))

uncert_year<-ggplot(filter(bio_dataOCD, fao_official != "Arctic Sea"), aes(x=fao_official, y=mean_change, group=scenario, color=scenario)) + 
  geom_point()+ 
  geom_errorbar(aes(ymin=mean_change-sd_change, ymax=mean_change+sd_change), width=.2,
                position=position_dodge(0.05))+
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", linewidth = 1)+
  scale_color_manual(name = "Scenario", labels = c("SSP1-2.6", "SSP5-8.5"), values=c("#33bbee", "#ee3377"))+ 
  labs(x="FAO Major Fishing Area", y = "Change in exploitable fish biomass (%)") +
  coord_flip()+
  theme(axis.text=element_text(size=14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title=element_text(size=14)) + # face = "bold"
  facet_wrap(~year)

png("figures/FAOarea_uncertity_year.png", width=10, height=5, units="in",res=1200)
uncert_year
dev.off()

```

## Plotting trends globally and for top 7 countries
  
```{r}
#Merging global and top 7 countries data
global_data |> 
  #Add an extra column to match top 7 countries
  mutate(fao_official = "Global", .after = "scenario") |> 
  #Joining to top7 data
  bind_rows(top7_base_data) |> 
  #Create an order category for SOVEREIGN1
  mutate(fao_official = factor(fao_official, 
                               levels = c("Global", 
                                          unique(top7_base_data$fao_official)), 
                             ordered = T)) |> 
  #Plotting
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  #Applying base plot design
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", nrow = 8)

```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "top_7_global_trends.pdf"), 
       device = "pdf", width = 6, height = 12)
```
  
## Figure 2 - Asia
In this figure, we will exclude marine areas under the jurisdiction of countries in Asia as classified by the FAO.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in Asia
  filter(continent == "Asia") |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(fao_official = label_wrap_gen(20)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "asia_perc_change.pdf"), 
       device = "pdf", width = 10, height = 14.35)
```
  
## Figure 3 - Africa
In this figure, we will exclude marine areas under the jurisdiction of countries in Africa as classified by the FAO.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in Africa
  filter(continent == "Africa") |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", ncol = 5, 
             #Ensure labels wrap at ~30 characters
             labeller = labeller(fao_official = label_wrap_gen(20)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "africa_perc_change.pdf"), 
       device = "pdf", width = 10, height = 14.35)
```
  
## Figure 4 - Europe
In this figure, we will exclude marine areas under the jurisdiction of countries in Europe as classified by the FAO.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in Europe
  filter(continent == "Europe") |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(fao_official = label_wrap_gen(25)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "europe_perc_change.pdf"),
       device = "pdf", width = 12, height = 16)
```
  
## Figure 5 - Americas
In this figure, we will exclude marine areas under the jurisdiction of countries in the Americas as classified by the FAO.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in the Americas
  filter(continent == "Americas") |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(fao_official = label_wrap_gen(25)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "americas_perc_change.pdf"), 
       device = "pdf", width = 12, height = 17.22)
```
  
## Figure 6 - Oceania
In this figure, we will exclude marine areas under the jurisdiction of countries in Oceania as classified by the FAO.  
  
```{r}
#Filtering data
bio_data |> 
  #Extract EEZs in Oceania
  filter(continent == "Oceania") |> 
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by country
  facet_wrap(~fao_official, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(fao_official = label_wrap_gen(25)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "oceania_perc_change.pdf"),
       device = "pdf", width = 10, height = 9)
```
  
## Figure 7 - FAO regions
  
```{r}
#Filtering data
bio_data |> 
  #Removing EEZs
  drop_na(OCEAN) |> 
  #Plotting data
  ggplot(aes(x = year, y = mean_change, colour = scenario))+
  base_gg+
  #Plotting by FAO sector
  facet_wrap(~fao_official, scales = "free_y", ncol = 5,
             #Ensure labels wrap at ~30 characters
             labeller = labeller(official = label_wrap_gen(30)))
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "fao_regions_perc_change.pdf"), 
       device = "pdf", width = 10, height = 6)
```
  

  