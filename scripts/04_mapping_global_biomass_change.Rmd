---
title: "Plotting biomass change under different SSPs"
author: "Denisse Fierro Arcos"
date: "2024-01-09"
output: pdf_document
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
library(readxl)
#Data wrangling
library(tidyverse)
library(data.table)
library(janitor)
#Plotting
library(ggnewscale)
#Dealing with raster data
library(terra)
library(tidyterra)
#Dealing with vector data
library(sf)
#Base maps
library(rnaturalearth)
#Color palettes
library(cmocean)
#Combining plots
library(cowplot)
```

## Setting up notebook
This notebook uses a modified version of the Exclusive Economic Zones boundaries (version 11) from the [Flanders Marine Institute (2019)](https://doi.org/10.14284/386). Available [online](https://www.marineregions.org/). The following modifications were made:  
- Boundaries for South Georgia and Sandwich Islands were updated to boundaries provided by the UN  
- Boundaries around Bouvet Island (Norway) in the south Atlantic were added to this shapefile  
- Country boundaries were dissolved and polygons were reclassified by continent  
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

#FAO_EEZ keys - Contains continent information
fao_eez <- read_csv(list.files(out_folder, pattern = "_keys.csv", 
                               full.names = T, recursive = T))

#FAO_EEZ mask - Contains IDs for FAO and EEZ areas
fao_eez_mask <- read_csv(list.files(out_folder, pattern = "_1deg.csv", 
                                    full.names = T, recursive = T)) |> 
  rename(x = Lon, y = Lat, ID_mrgd = mask)

#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()
```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Extract data only for years to be used in maps
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #The new group column also need to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, sep = "_"),
                             T ~ group)) |> 
    #Apply mask
    left_join(fao_eez_mask, by = join_by(x, y)) |> 
    #Calculate mean per ensemble member
    group_by(x, y, mem, esm, ID_mrgd, group) |> 
    summarise(mean_bio = mean(biomass, na.rm = T)) |> 
    #Reorganise table to facilitate calculations
    pivot_wider(names_from = group, values_from = mean_bio) |> 
    ungroup() |> 
    #Calculate % change in fish biomass for the two emissions scenarios
    mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
           rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
           rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
           rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)
  
  #Create name to save file  
  f_out <- file.path(out_folder, str_c(m, "_perc_bio_change_data_map.csv"))
  
  #Saving results for each model
  df_model |> 
    fwrite(f_out)
}
```
  
### Calculating ensemble mean
We will now load the percentage change in biomass for all global models and calculate an ensemble mean.  
  
```{r}
#Listing all relevant files to calculate biomass projections
maps_data <- list.files(out_folder, pattern = "_perc_bio_change_data_map.csv", 
                        full.names = T) |> 
  map_df(~fread(.)) |> 
  #Calculations performed by year and EEZ
  group_by(x, y, ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(reference:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(mean = mean), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup()
```
  
## Loading information about continents
We will add information about the continents where each EEZ is located.  
  
```{r}
#Merge with biomass data
maps_data <- maps_data |> 
  inner_join(fao_eez, by = join_by(ID_mrgd)) |> 
  #If a grid cell is not assigned to an EEZ, then change to NA
  mutate(across(starts_with("rel_change"), ~ case_when(is.na(ID_mrgd) ~ NA,
                                                      T ~ .x)))
```
  
## Loading relevant shapefiles
We will apply a Robinson projection to all shapefiles before plotting them.  
  
```{r}
#Robinson projection
rob_proj <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +type=crs"

#Base map
world_proj <- read_sf(list.files(out_folder, pattern = "country_bounds.shp",
                                 full.names = T, recursive = T)) |> 
  st_transform(rob_proj)

#Boundaries provided by UN
world_bound <- read_sf(list.files(out_folder, pattern = "UN_intbnd.shp", 
                                  full.names = T, recursive = T)) |> 
  #Selecting boundary types to be included in the map
  filter(TYPE < 99) |> 
  st_transform(rob_proj)

#EEZ boundaries
fao_eez_proj <- read_sf(list.files(out_folder, 
                               pattern = "FAO_MajorAreas_200NM_cont.shp", 
                               recursive = T, full.names = T)) |> 
  st_transform(rob_proj)

#FAO and EEZ shapefile
eez_proj <- fao_eez_proj |> 
  drop_na(MRGID)

#Getting FAO regions only
fao_proj <- fao_eez_proj |>
  drop_na(OCEAN)
```
  
## Figure 1 FAO report - Map showing regions used in report
FAO regions are coloured by ocean basin, and EEZs are classified by continent.  
  
```{r}
main <- ggplot()+
  #Plotting FAO classified by ocean basin
  geom_sf(data = fao_proj, aes(fill = OCEAN))+
  #Plotting EEZ classified by continent
  geom_sf(data = eez_proj, aes(fill = CONTINENT))+
  #Using colour blind friendly colours
  scale_fill_manual(values = c("Pacific" = "#222255", "Atlantic" = "#225555", 
                               "Indian" = "#225522", "Arctic" = "#666633", 
                               "Oceania" = "#bbccee", "Europe" = "#cceeff", 
                               "Americas" = "#ccddaa", "Africa" = "#eeeebb",
                               "Southern Ocean" = "#663333", 
                               "Asia" = "#ffcccc"))+
  #Plotting base map and country boundaries
  geom_sf(data = world_proj, color = "#dbdade", fill = "#dbdade")+
  #Adding coastlines and international boundaries
  geom_sf(data = world_bound, lwd = 0.25, color = "black", show.legend = F, 
          aes(linetype = as.factor(TYPE)))+
  scale_linetype_manual(values = c("0" = "solid", "1" = "twodash", 
                                   "2" = "dotdash", "3" = "dashed", 
                                   "4" = "dotted"))+
  geom_sf(data = world_bound[world_bound$TYPE == 8,], linetype = "longdash", 
          lwd = 0.25, color = "#838285", show.legend = F)+
  #Removing grey background
  theme_bw()+
  #Formatting legend title
  guides(fill = guide_legend(title = "FAO and EEZ classification", 
                             title.position = "top", title.hjust = 0.5))+
  #Formatting legend
  theme(legend.position = "bottom", panel.border = element_rect(colour = NA),
        legend.margin = margin(0, 0, 0, 0), 
        legend.box.margin = margin(0, 0, 0, 0),
        legend.title = element_text(size = 13), 
        legend.text = element_text(size = 13))

#Checking result
main
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "fao_eez_global_map.pdf"), main, 
       device = "pdf", width = 14, height = 9)
```
  
## Figure 2 FAO report - Percentage change per decade and scenario.
In this figure, we will show percentage fish biomass change in the ocean, while yearly mean capture fisheries production per country (2012-2021) will be shown on land.

Capture fisheries production data comes from the [FAO's Fisheries and Aquaculture Data Portal](https://www.fao.org/fishery/statistics-query/en/global_production/global_production_quantity). 
  
```{r}
#Load fisheries data
fisheries_catch <- read_csv(list.files(out_folder, 
                                       pattern = "global_production_quantity.csv", 
                                       full.name = T)) |> 
  #Keeping only columns that are relevant to us (country name and years)
  #The flag column identifies which values are estimates (E) and which values
  #are "more than zero but less than half the unit used" (N)
  select(!c(contains("Flag")|`Unit Name`)) |> 
  #Simplify column names
  clean_names() |> 
  #Reclassifying Zanzibar as Tanzania
  mutate(country_name_en = case_when(str_detect(country_name_en, "Tanzania") ~
                                    "United Republic of Tanzania",
                                  #Matching country names to FAO country list
                                  str_detect(country_name_en, "Congo,") ~
                                    "Democratic Republic of the Congo",
                                  str_detect(country_name_en, "Falkland") ~
                                    "Falkland Islands (Malvinas)",
                                  str_detect(country_name_en, "French Southern") ~
                                    "French Southern Territories",
                                  str_detect(country_name_en, "Venezuela") ~
                                    "Venezuela (Bolivarian Republic of)",
                                  str_detect(country_name_en, "Korea, Dem") ~
                                    "Democratic People's Republic of Korea",
                                  str_detect(country_name_en, "Korea, Republic") ~
                                    "Republic of Korea",
                                  str_detect(country_name_en, "Iran") ~
                                    "Iran (Islamic Republic of)",
                                  str_detect(country_name_en, "United Kingdom") ~
                                    "United Kingdom of Great Britain and Northern Ireland",
                                  T ~ country_name_en)) |>
  #Add rows with the same country name
  group_by(country_name_en) |> 
  summarise(across(x2012:x2021, list(sum = sum), .names = "{.col}")) |> 
  #Reorganise table to calculate means
  pivot_longer(!country_name_en, values_to = "annual_catch", names_to = "year") |> 
  #Calculate mean annual catch per country
  group_by(country_name_en) |> 
  #Dividing by 1,000,000 to show data in maps as millions of tonnes
  summarise(mean_annual_catch = mean(annual_catch, na.rm = T)*1e-6) |> 
  #Create new column with classification
  mutate(class_fish = cut(mean_annual_catch, 
                          #Including a small negative number to include 
                          #countries with 0 values in first group
                          breaks = c(-1e-6, .25, 1, 2, 4, 6, 20),
                          labels = c("<0.25", "0.25-1", "1-2", "2-4", "4-6", 
                                     ">6")))

#Fisheries data does not contain identifiers for countries, we will match
#the above summary to the country ISO codes from the FAO
fao_countries <- read_excel(list.files(out_folder, 
                                      pattern = "FAO_countries_list", 
                                      full.names = T),
                           sheet = "Codes") |> 
  #Simplify column names
  clean_names() |> 
  #Select columns of interest
  select(list_name, iso3)
  
#Add ISO codes to fisheries data
fisheries_catch <- fisheries_catch |> 
  left_join(fao_countries, by = c("country_name_en" = "list_name"))

#Now we can add this information to the world map by performing a data frame join
world_proj <- world_proj |> 
  left_join(fisheries_catch |> select(!country_name_en), 
            by = join_by("ISO3CD" == "iso3"))
```
  
We will transform the data frame containing the percentage change into a multi-layer raster, and apply a Robinson projection. We will also create a custom-made colour palette for the maps.  
  
```{r}
#Extract data for scenario, transform to raster and reproject
maps_data_proj <- maps_data |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, starts_with("rel_change")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 

#Create custom-made color palette
scale_fill_custom <- function(..., alpha = 1, begin = 0, end = 1, direction = 1, 
  option = "D", values = NULL, space = "Lab", na.value = "white", 
  guide = "colourbar", aesthetics = "fill") {
  continuous_scale(aesthetics, scale_name = "custom", 
    palette = scales:::gradient_n_pal(c(cmocean("matter", start = 0.1, 
                                                end = 0.8, direction = -1)(123),
                                        cmocean("delta", start = 0.49, 
                                                end = 0.5)(20),
                                        cmocean("deep", start = 0.1, 
                                                end = 0.8)(123)), values, space), 
    na.value = na.value, guide = guide, ...)
}
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                                  type = scale_fill_custom,
                                  oob = scales::oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = world_proj, color = NA, 
                        aes(fill = class_fish), show.legend = F),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound[world_bound$ISO3_CNT1 == "ATA",],
                        lwd = 0.25, linetype = "solid", color = "#5b5b5b", 
                        show.legend = F),
                geom_sf(inherit.aes = F, 
                        data = world_bound[world_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA,
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#Plotting land masses to get legend
land <- ggplot()+
  geom_sf(data = world_proj, aes(fill = class_fish))+
  scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc", 
                    guides(title = "Yearly landings between 2012-2021 (million tonnes)"),
                    labels = c("<0.25", "0.25-1", "1-2", "2-4", "4-6", ">6", "No data"))+
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5, 
                             barwidth = 15, 
                             label.position = "bottom", nrow = 1, 
                             keywidth = unit(1.25, "cm"), label.hjust = 0.5))+
  theme(legend.position = "bottom")
#Get legend for land
leg_land <- get_legend(land)

#Plotting fish biomass to get legend
fish <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp126_mean)+
  scale_fill_binned(limits = c(-50, 50), n.breaks = 8, type = scale_fill_custom, 
                    oob = scales::oob_squish, 
                    guides(title = "% change in fish biomass"))+
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")
#Get legend for land
leg_fish <- get_legend(fish)

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp126_mean)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp585_mean)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp126_mean)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp585_mean)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
all_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                 labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                       ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Check final map
all_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 14, height = 9)
```
  
## Figure 3 FAO report - Asia 
Loading relevant shapefiles and extracting data for Asia.  
  
```{r}
#Unprojected UN-approved world base map
world <- read_sf(list.files(out_folder, pattern = "country_bounds.shp",
                                 full.names = T, recursive = T))
#Boundaries provided by UN
world_bound_wgs84 <- read_sf(list.files(out_folder, pattern = "UN_intbnd.shp", 
                                  full.names = T, recursive = T)) |> 
  #Selecting boundary types to be included in the map
  filter(TYPE < 99) 

#EEZ boundaries
eez <- read_sf(list.files(out_folder, 
                          pattern = "FAO_MajorAreas_200NM_cont.shp", 
                          recursive = T, full.names = T)) |> 
  drop_na(MRGID)

#Extract data for scenario, transform to raster and reproject
asia_data <- maps_data |> 
  filter(CONTINENT == "Asia")
```
  
Loading population data and calculating percentage difference in human populations.  
  
```{r}
#Population change data
pop_sum <- function(file){
  df <- read_csv(file, skip = 4) |> 
    #Reorganise data calculate relative change
    pivot_longer(!c(iso, country), names_to = "year", 
                 values_to = "population") |> 
    mutate(year = as.numeric(year)) |> 
    #Keep only relevant years
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(scenario = str_extract(file, "population_(.*)_nat", group = 1),
           group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #The new group column also need to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, 
                                                          sep = "_"),
                             T ~ group)) |> 
    #Calculate mean population per country and group
    group_by(iso, country, group) |> 
    summarise(mean_pop = mean(population, na.rm = T))
}

#Getting list of all relevant files
file_list <- list.files("../data/", pattern = "national_annual", full.names = T)

#Apply function to all relevant files
pop_change <- file_list |> 
  map(~pop_sum(.)) |> 
  #Join all data frames
  map_df(~bind_rows(.)) |> 
  #Reorganise data
  pivot_wider(names_from = group, values_from = mean_pop) |> 
  ungroup() |> 
  #Calculate % change in fish biomass for the two emissions scenarios
  mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
         rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
         rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
         rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)

#Now we can add this information to the world map by performing a data frame join
world <- world |> 
  left_join(pop_change |> select(!country), by = join_by("ISO3CD" == "iso"))
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eez[eez$CONTINENT == "Asia",], 
                        fill = NA, colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = world[world$CONTCD != "ASI",], color = "#dbdade",
                        fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_wgs84, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_wgs84[world_bound_wgs84$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5), 
                      legend.position = "none"),
                lims(x = c(25, 160), y = c(-15, 50)))

#SSP1-2.6 2041-2050
p50_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean50_ssp126), 
          colour = NA)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean50_ssp585), 
          colour = NA)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean00_ssp126), 
          colour = NA)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean00_ssp585), 
          colour = NA)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "% changes in human population\nand in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 25))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
asia_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                  labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Check final map
asia_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "asia_perc_change_map_50-00.pdf"), device = "pdf",
       width = 14, height = 9)
```
  
## Figure 4 FAO report - Africa
  
```{r}
#Extract data for scenario, transform to raster and reproject
africa_data <- maps_data |> 
  filter(CONTINENT == "Africa")
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eez[eez$CONTINENT == "Africa",], 
                        fill = NA, colour = "#5b5b5b", show.legend = F, 
                        linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = world[world$CONTCD != "AFR",], color = "#dbdade",
                        fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_wgs84, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_wgs84[world_bound_wgs84$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                lims(x = c(-29, 85), y = c(-55, 40)))

#SSP1-2.6 2041-2050
p50_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean50_ssp126), 
          colour = NA)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean50_ssp585), 
          colour = NA)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean00_ssp126), 
          colour = NA)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = world, aes(fill = rel_change_mean00_ssp585), 
          colour = NA)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "% changes in human population\nand in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 25))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
africa_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                    labels = c("a", "b"), label_x = 0.1),
                          plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                    labels = c("c", "d"), label_x = 0.1),
                          legend, ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Check final map
africa_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "africa_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 10, height = 9)
```
  
## Figure 5 FAO report - Europe
Since we want to show Europe in the middle of the map, we will have to project our data and split the base map in two hemispheres.  
  
```{r}
sf_use_s2(F)

#Split world in two hemispheres
east <- st_crop(world, st_bbox(c(xmin = -50, ymin = 20, 
                                 xmax = 180, ymax = 90)))
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = 20, 
                                 xmax = -150, ymax = 90)))
#Merge them together
eurocent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                             st_crs(east)), east) 

#Split world boundaries in two hemispheres
east <- st_crop(world_bound_wgs84, st_bbox(c(xmin = -50, ymin = 20, 
                                 xmax = 180, ymax = 90)))
west <- st_crop(world_bound_wgs84, st_bbox(c(xmin = -180, ymin = 20, 
                                 xmax = -150, ymax = 90)))
#Merge them together
eurocent_bound <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                             st_crs(east)), east) 

#Split EEZ in two hemispheres
eez_east <- st_crop(eez[eez$CONTINENT == "Europe",], 
                    st_bbox(c(xmin = -50, ymin = 20, xmax = 180, ymax = 90)))
eez_west <- st_crop(eez[eez$CONTINENT == "Europe",], 
                    st_bbox(c(xmin = -180, ymin = 20, xmax = -150, ymax = 90)))
#Merge together
eez_euro <- rbind(st_set_crs(st_transform(eez_west, 
                                          "+proj=longlat +lon_wrap=180"), 
                             st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for Europe
europe_data <- maps_data |>
  filter(CONTINENT == "Europe") |> 
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Europe
  project(rast(ext(-50, 210, 20, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eez_euro, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = eurocent[eurocent$CONTCD != "EUR",], 
                        color = "#dbdade", fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = eurocent_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = eurocent_bound[eurocent_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(23, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = eurocent, 
          aes(fill = rel_change_mean50_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = eurocent, 
          aes(fill = rel_change_mean50_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = eurocent, 
          aes(fill = rel_change_mean00_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = eurocent, 
          aes(fill = rel_change_mean00_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "% changes in human population\nand in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 25))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
europe_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                    labels = c("a", "b"), label_x = 0.1),
                          plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                    labels = c("c", "d"), label_x = 0.1),
                          legend, ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(eez_euro, eurocent, eurocent_bound)

#Check final map
europe_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "europe_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 10, height = 6)
```
  
## Figure 6 FAO report - Americas
As we did with Europe, we would like the Americas to show in the middle of the map, so we will have to pre-process our data before plotting the maps.  
  
```{r}
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = 20, ymax = 90)))
east <- st_crop(world, st_bbox(c(xmin = 160, ymin = -60, 
                                 xmax = 180, ymax = 90)))
#Merge them together
amercent <- rbind(west, st_set_crs(st_transform(east, 
                                                "+proj=longlat +lon_wrap=-120"),
                                   st_crs(west)))

#Split world boundaries in two hemispheres 
west <- st_crop(world_bound_wgs84, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = 20, ymax = 90)))
east <- st_crop(world_bound_wgs84, st_bbox(c(xmin = 160, ymin = -60, 
                                 xmax = 180, ymax = 90)))
#Merge them together
amercent_bound <- rbind(west, st_set_crs(st_transform(east, 
                                                "+proj=longlat +lon_wrap=-120"),
                                   st_crs(west)))

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(CONTINENT == "Americas") |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = 20, ymax = 90)))
eez_east <- eez |> 
  filter(CONTINENT == "Americas") |> 
  st_crop(st_bbox(c(xmin = 160, ymin = -60, xmax = 180, ymax = 90)))
#Merge together
eez_amer <- rbind(eez_west, st_set_crs(st_transform(eez_east, 
                                                    "+proj=longlat +lon_wrap=-120"),
                                   st_crs(eez_west))) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for the Americas
americas_data <- maps_data |>
  filter(CONTINENT == "Americas") |> 
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in the Americas
  project(rast(ext(-200, 20, -60, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eez_amer, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = amercent[amercent$CONTCD != "AME",],
                        color = "#dbdade", fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = amercent_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = amercent_bound[amercent_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(-60, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = amercent, 
          aes(fill = rel_change_mean50_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = amercent, 
          aes(fill = rel_change_mean50_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = amercent, 
          aes(fill = rel_change_mean00_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = amercent, 
          aes(fill = rel_change_mean00_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "% changes in human population\nand in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 25))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
americas_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                      labels = c("a", "b"), label_x = 0.1),
                            plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                      labels = c("c", "d"), label_x = 0.1),
                            legend, ncol = 1, nrow = 3, 
                            rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(amercent, amercent_bound, eez_amer)

#Check final map
americas_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "americas_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 10, height = 9)
```
  
## Figure 7 FAO report - Oceania

```{r}
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = -120, ymax = 30)))
east <- st_crop(world, st_bbox(c(xmin = 60, ymin = -60, 
                                 xmax = 180, ymax = 30)))
#Merge them together
oceancent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                              st_crs(east)), east)

#Split world boundaries in two hemispheres 
west <- st_crop(world_bound_wgs84, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = -120, ymax = 30)))
east <- st_crop(world_bound_wgs84, st_bbox(c(xmin = 60, ymin = -60, 
                                 xmax = 180, ymax = 30)))
#Merge them together
oceancent_bound <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                              st_crs(east)), east)

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(CONTINENT == "Oceania") |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = -120, ymax = 30)))
eez_east <- eez |> 
  filter(CONTINENT == "Oceania") |> 
  st_crop(st_bbox(c(xmin = 60, ymin = -60, xmax = 180, ymax = 30)))
#Merge together
eez_ocean <- rbind(st_set_crs(st_transform(eez_west, 
                                           "+proj=longlat +lon_wrap=180"), 
                              st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for Oceania
ocean_data <- maps_data |>
  filter(CONTINENT == "Oceania") |>
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Oceania
  project(rast(ext(60, 240, -60, 30), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eez_ocean, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = oceancent[oceancent$CONTCD != "OCE",],
                        color = "#dbdade", fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = oceancent_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = oceancent, 
          aes(fill = rel_change_mean50_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = oceancent, 
          aes(fill = rel_change_mean50_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = oceancent, 
          aes(fill = rel_change_mean00_ssp126), colour = NA)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  geom_sf(inherit.aes = F, data = oceancent, 
          aes(fill = rel_change_mean00_ssp585), colour = NA)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "% changes in human population\nand in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 25))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
oceania_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                     labels = c("a", "b"), label_x = 0.1),
                           plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                     labels = c("c", "d"), label_x = 0.1),
                           legend, ncol = 1, nrow = 3, 
                           rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(oceancent, oceancent_bound, eez_ocean)

#Check final map
oceania_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "oceania_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 11, height = 8)
```
    
## Figure 8 FAO report - FAO regions
Finally, we will create maps for the FAO regions. This will a choropleth map showing the weighted average change in fish biomass.  
  
```{r}
#Loading area per grid cell
area_grid <- rast(list.files(out_folder, pattern = "^area_1deg.nc", 
                             recursive = T, full.names = T)) |> 
  #Transform to data frame
  as.data.frame(xy = T)

#Add area to percentage change data to calculate weighted % change per sector
choro_data <- list.files(out_folder, pattern = "_perc_bio_change_data_map.csv", 
                        full.names = T) |> 
  map_df(~fread(.)) |> 
  left_join(area_grid, by = join_by(x, y)) |> 
  #Calculate weights by area
  group_by(ID_mrgd) |> 
  mutate(sum_area = sum(area_m, na.rm = T),
         weight = area_m/sum_area,
         across(rel_change_mean50_ssp126:rel_change_mean00_ssp585,
                ~.x*weight)) |> 
  #Group by sector
  group_by(ID_mrgd) |> 
  #Apply calculations to weighted biomass change only
  summarise(across(rel_change_mean50_ssp126:rel_change_mean00_ssp585, 
                   #Sum weighted values
                   ~ sum(.x, na.rm = T))) |> 
  ungroup()

#Add to FAO EEZ mask
choro_data_proj <- fao_eez_mask |> 
  left_join(choro_data, by = "ID_mrgd") |> 
  select(!ID_mrgd) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```

  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                                  type = scale_fill_custom, 
                                  oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = fao_proj, fill = NA, 
                        colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, data = eez_proj, fill = "white",
                        colour = "white", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F,
                        color = "#dbdade", fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound[world_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean50_ssp126)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean50_ssp585)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean00_ssp126)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean00_ssp585)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "weighted mean for change in fish biomass",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Plotting everything together
fao_reg_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                     labels = c("a", "b"), label_x = 0.1),
                           plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                     labels = c("c", "d"), label_x = 0.1),
                           legend, ncol = 1, nrow = 3, 
                           rel_heights = c(1, 1, 0.4))

#Check final map
fao_reg_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "fao_regions_perc_change_map_50-00.pdf"), 
       device = "pdf", width = 14, height = 9)
```
  
## Figure 9 FAO report - FAO sustainable fisheries
Finally, we will create a choropleth map for the proportion of sustainable fisheries within FAO regions for 2019.  
  
```{r}
#Loading FAO fisheries data
fao_fisheries <- read_csv(list.files(out_folder, 
                                     pattern = "FAO_fisheries_data.csv",
                                     full.names = T, recursive = T), 
                          #Keeping only relevant columns
                          col_select = c("GEO_AREA_NAME", "OBS_VALUE")) |>
  #We will simplify the names of the regions to merge with our FAO data
  mutate(GEO_AREA_NAME = str_remove(GEO_AREA_NAME, "FAO Major Fishing Area: "))

fao_fisheries <- fao_proj |> 
  left_join(fao_fisheries, by = join_by("NAME_EN" == "GEO_AREA_NAME"))

#Checking result
fao_fisheries
```
  
Finally, we can map this information.  
  
```{r}
 ggplot()+
  geom_sf(data = eez_proj, fill = "white", colour = "white")+
  #Plotting FAO classified by ocean basin
  geom_sf(data = fao_fisheries, aes(fill = OBS_VALUE))+
  scale_fill_distiller(palette = "YlGnBu", direction = 1)+
  #Plotting base map
  geom_sf(data = world_proj, color = "#dbdade", fill = "#dbdade")+
  #Adding coastlines and international boundaries
  geom_sf(data = world_bound, lwd = 0.25, color = "black", show.legend = F, 
          aes(linetype = as.factor(TYPE)))+
  scale_linetype_manual(values = c("0" = "solid", "1" = "twodash", 
                                   "2" = "dotdash", "3" = "dashed", 
                                   "4" = "dotted"))+
  geom_sf(data = world_bound[world_bound$TYPE == 8,], linetype = "longdash", 
          lwd = 0.25, color = "#838285", show.legend = F)+
  #Removing grey background
  theme_bw()+
  #Formatting legend title
  guides(fill = guide_colorbar(title = "% sustainable fisheries", title.position = "top", 
                             title.hjust = 0.5, barwidth = 15))+
  #Formatting legend
  theme(legend.position = "bottom", panel.border = element_rect(colour = NA),
        legend.margin = margin(0, 0, 0, 0), legend.box.margin = margin(0, 0, 0, 0))
```
  
```{r}
# Saving fisheries map
ggsave(file.path(out_folder, "fao_regions_perc_sustainable_fisheries.pdf"), device = "pdf",
       width = 14, height = 9)
```
  
## Figure 10 FAO report - FAO standard deviation
### Calculating standard deviation in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the standard deviation for fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Listing all relevant files to calculate biomass projections
maps_data_sd <- list.files(out_folder, pattern = "_perc_bio_change_data_map.csv", full.names = T) |> 
  map_df(~fread(.)) |> 
  #Calculations performed by year and EEZ
  group_by(x, y, ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(rel_change_mean50_ssp126:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(sd = sd), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup()

#Extract data for scenario, transform to raster and reproject
maps_data_sd_proj <- maps_data_sd |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, ends_with("_sd")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_distiller(palette = "Blues", direction = 1, 
                                     na.value = NA, limits = c(0, 50), 
                                     oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F,
                        color = "#dbdade", fill = "#dbdade"),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA, 
                        colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound[world_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean50_ssp126_sd)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean50_ssp585_sd)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean00_ssp126_sd)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean00_ssp585_sd)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "Standard deviation",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")

#Get legend for land
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
all_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                 labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 3, 
                       rel_heights = c(1, 1, 0.4))

#Checking results
all_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_sd_map_50-00.pdf"), device = "pdf",
       width = 14, height = 9)
```

