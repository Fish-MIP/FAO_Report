---
title: "Plotting biomass change under different SSPs"
author: "Denisse Fierro Arcos"
date: "2024-01-09"
output: pdf_document
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
library(data.table)
#Dealing with raster data
library(terra)
library(tidyterra)
#Dealing with vector data
library(sf)
#Base maps
library(rnaturalearth)
#Color palettes
library(cmocean)
#Combining plots
library(cowplot)
```

## Setting up notebook
  
```{r}
#FAO_EEZ key - Contains continent information
fao_eez <- read_csv("../../Merged_FAO_EEZ/FAO-MajorAreas_EEZs_keys.csv")

#FAO_EEZ mask - Contains IDs for FAO and EEZ areas
fao_eez_mask <- read_csv("../../Merged_FAO_EEZ/Outputs/masked_area_1deg.csv") |> 
  rename(x = Lon, y = Lat, ID_mrgd = mask)

#Defining location of notebook outputs
out_folder <- "/rd/gem/private/users/camillan/FAO_Report"
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

#Defining location of model outputs
data_dir <- "/rd/gem/private/users/camillan/Extract_tcblog10_Data/Output/sumSize_annual/sizeConsidered10g_100kg/" 

#Getting a list of files containing biomass data
global_files <- list.files(data_dir, pattern = "rds$", full.names = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()
```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Extract data only for years to be used in maps
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #The new group column also need to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, sep = "_"),
                             T ~ group)) |> 
    #Apply mask
    left_join(fao_eez_mask, by = join_by(x, y)) |> 
    #Calculate mean per ensemble member
    group_by(x, y, mem, esm, ID_mrgd, group) |> 
    summarise(mean_bio = mean(biomass, na.rm = T)) |> 
    #Reorganise table to facilitate calculations
    pivot_wider(names_from = group, values_from = mean_bio) |> 
    ungroup() |> 
    #Calculate % change in fish biomass for the two emissions scenarios
    mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
           rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
           rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
           rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)
  
  #Create name to save file  
  f_out <- file.path(out_folder, str_c(m, "_perc_bio_change_data_map.csv"))
  
  #Saving results for each model
  df_model |> 
    fwrite(f_out)
}
```
  
### Calculating ensemble mean
We will now load the percentage change in biomass for all global models and calculate an ensemble mean.  
  
```{r}
#Listing all relevant files to calculate biomass projections
maps_data <- list.files(out_folder, pattern = "_perc_bio_change_data_map.csv", full.names = T) |> 
  map_df(~fread(.)) |> 
  #Calculations performed by year and EEZ
  group_by(x, y, ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(reference:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(mean = mean), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup()
```
## Loading information about continents
We will add information about the continents where each EEZ is located.  
  
```{r}
#Merge with biomass data
maps_data <- maps_data |> 
  inner_join(fao_eez, by = join_by(ID_mrgd)) |> 
  #If a grid cell is not assigned to an EEZ, then change to NA
  mutate(across(starts_with("rel_change"), ~ case_when(is.na(ID_mrgd) ~ NA,
                                                      T ~ .x)))
```
  
## Loading relevant shapefiles
We will apply a Robinson projection to all shapefiles before plotting them.  
  
```{r}
#Robinson projection
rob_proj <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +type=crs"

#Base map of the world
world_proj <- ne_countries(returnclass = "sf") |> 
  st_transform(rob_proj)

#EEZ boundaries
eez_proj <- read_sf("../../World_EEZ_v11_20191118/eez_short.shp") |> 
  #Removing Antarctic EEZ
  filter(str_detect(GEONAME, "Antarctic", negate = T)) |> 
  #Adding continent and sub region information 
  left_join(fao_eez |> drop_na(MRGID), by = join_by(MRGID)) |> 
  #Removing continent from Clipperton
  mutate(region = case_when(str_detect(nm_mrgd, "Clipperton") ~ NA,
                            T ~ region)) |> 
  st_transform(rob_proj)

#FAO and EEZ shapefile
fao_eez_shp_proj <- read_sf("../../Merged_FAO_EEZ/FAO_MajorAreas_EEZ.shp") |> 
  st_transform(rob_proj)
```
  
## Figure 1 FAO report: Map showing regions used in report
FAO regions are coloured by ocean basin, and EEZs are classified by continent.  
  
```{r}
#Getting FAO regions only
fao_proj <- fao_eez_shp_proj |> 
  drop_na(OCEAN)

main <- ggplot()+
  #Plotting FAO classified by ocean basin
  geom_sf(data = fao_proj, aes(fill = OCEAN))+
  #Plotting EEZ classified by continent
  geom_sf(data = eez_proj, aes(fill = region))+
  #Using colour blind friendly colours
  scale_fill_manual(values = c("Pacific" = "#222255", "Atlantic" = "#225555", "Indian" = "#225522",
                               "Arctic" = "#666633", "Southern Ocean" = "#663333", 
                               "Oceania" = "#bbccee", "Europe" = "#cceeff", "Americas" = "#ccddaa",
                               "Asia" = "#ffcccc", "Africa" = "#eeeebb"))+
  #Plotting base map
  geom_sf(data = world_proj)+
  #Removing grey background
  theme_bw()+
  #Formatting legend title
  guides(fill = guide_legend(title = "FAO and EEZ classification", title.position = "top", 
                             title.hjust = 0.5))+
  #Formatting legend
  theme(legend.position = "bottom", panel.border = element_rect(colour = NA),
        legend.margin = margin(0, 0, 0, 0), legend.box.margin = margin(0, 0, 0, 0),
        legend.title = element_text(size = 13), legend.text = element_text(size = 13))

#Checking result
main
```
  
```{r, eval = F}
#Saving plot
ggsave(filename = file.path(out_folder, "fao_eez_global_map.pdf"), main, device = "pdf",
       width = 14, height = 9)
```
  
## Figure 2 FAO report: Percentage change per decade and scenario.
First, we will transform the data frame containing the percentage change into a multi-layer raster, and apply a Robinson projection. We will also create a custom-made colour palette for the maps.  
  
```{r}
#Extract data for scenario, transform to raster and reproject
maps_data_proj <- maps_data |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, starts_with("rel_change")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 

#Create custom-made color palette
scale_fill_custom <- function (..., alpha = 1, begin = 0, end = 1, direction = 1, 
  option = "D", values = NULL, space = "Lab", na.value = "white", 
  guide = "colourbar", aesthetics = "fill") {
  continuous_scale(aesthetics, scale_name = "custom", 
    palette = scales:::gradient_n_pal(c(cmocean("matter", start = 0.1, end = 0.8, direction = -1)(123),
                                        cmocean("delta", start = 0.49, end = 0.5)(20),
                                        cmocean("deep", start = 0.1, end = 0.8)(123)), 
                                      values, space), 
    na.value = na.value, guide = guide, ...)
}
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA, colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp126_mean)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp585_mean)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp126_mean)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp585_mean)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass from 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
all_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                        labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
all_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_perc_change_map_50-00.pdf"), device = "pdf",
       width = 14, height = 9)
```
  
## Figure 3 FAO report - Asia 

```{r}
#Unprojected world base map
world <- ne_countries(returnclass = "sf")

#EEZ boundaries
eez <- read_sf("../../World_EEZ_v11_20191118/eez_short.shp") |> 
  #Removing Antarctic EEZ
  filter(str_detect(GEONAME, "Antarctic", negate = T)) |> 
  #Adding continent and sub region information 
  left_join(fao_eez |> drop_na(MRGID), by = join_by(MRGID)) |> 
  #Removing continent from Clipperton
  mutate(region = case_when(str_detect(nm_mrgd, "Clipperton") ~ NA,
                            T ~ region))

#Extract data for scenario, transform to raster and reproject
asia_data <- maps_data |> 
  filter(region == "Asia")
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = world, show.legend = F),
                geom_sf(inherit.aes = F, data = eez[eez$region == "Asia",], 
                        fill = NA, colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5), 
                      legend.position = "none"),
                lims(x = c(25, 160), y = c(-15, 50)))

#SSP1-2.6 2041-2050
p50_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in Asian EEZs between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
asia_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                          labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
asia_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "asia_perc_change_map_50-00.pdf"), device = "pdf",
       width = 14, height = 9)
```
  
## Figure 4 FAO report - Africa
  
```{r}
#Extract data for scenario, transform to raster and reproject
africa_data <- maps_data |> 
  filter(region == "Africa")
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = world, show.legend = F),
                geom_sf(inherit.aes = F, data = eez[eez$region == "Africa",], 
                        fill = NA, colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                lims(x = c(-29, 85), y = c(-55, 40)))

#SSP1-2.6 2041-2050
p50_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2041-2050")

#SSP5-8.5 2041-2050
p50_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2041-2050")
#SSP1-2.6 2091-2100
p00_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2091-2100")
  
#SSP5-8.5 2091-2100
p00_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2091-2100")+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in African EEZs between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
africa_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                            labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
africa_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "africa_perc_change_map_50-00.pdf"), device = "pdf",
       width = 10, height = 9)
```
  
## Figure 5 FAO report - Europe
Since we want to show Europe in the middle of the map, we will have to project our data and split the base map in two hemispheres.  
  
```{r}
sf_use_s2(F)

#Split world in two hemispheres
east <- st_crop(world, st_bbox(c(xmin = -50, ymin = 20, xmax = 180, ymax = 90)))
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = 20, xmax = -150, ymax = 90)))
#Merge them together
eurocent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                             st_crs(east)), east) 

#Split EEZ in two hemispheres
eez_east <- st_crop(eez[eez$region == "Europe",], 
                    st_bbox(c(xmin = -50, ymin = 20, xmax = 180, ymax = 90)))
eez_west <- st_crop(eez[eez$region == "Europe",], 
                    st_bbox(c(xmin = -180, ymin = 20, xmax = -150, ymax = 90)))
#Merge together
eez_euro <- rbind(st_set_crs(st_transform(eez_west, "+proj=longlat +lon_wrap=180"), 
                             st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for Europe
europe_data <- maps_data |>
  filter(region == "Europe") |>
  #Removing Clipperton
  filter(str_detect(nm_mrgd, "Clipperton", negate = T)) |> 
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Europe
  project(rast(ext(-50, 210, 20, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = eurocent, show.legend = F),
                geom_sf(inherit.aes = F, data = eez_euro, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(23, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- europe_data |>
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2041-2050")

#SSP5-8.5 2041-2050
p50_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2041-2050")

#SSP1-2.6 2091-2100
p00_126 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2091-2100")
  
#SSP5-8.5 2091-2100
p00_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2091-2100")+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(axis.title = element_blank(), plot.title = element_text(hjust = 0.5), 
        legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in European EEZs between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
europe_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                            labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
europe_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "europe_perc_change_map_50-00.pdf"), device = "pdf",
       width = 12, height = 6)
```
  
## Figure 6 FAO report - Americas
As we did with Europe, we would like the Americas to show in the middle of the map, so we will have to pre-process our data before plotting the maps.  
  
```{r}
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, xmax = 20, ymax = 90)))
east <- st_crop(world, st_bbox(c(xmin = 160, ymin = -60, xmax = 180, ymax = 90)))
#Merge them together
amercent <- rbind(west, st_set_crs(st_transform(east, "+proj=longlat +lon_wrap=-120"),
                                   st_crs(west)))

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(str_detect(region, "America")) |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = 20, ymax = 90)))
eez_east <- eez |> 
  filter(str_detect(region, "America")) |> 
  st_crop(st_bbox(c(xmin = 160, ymin = -60, xmax = 180, ymax = 90)))
#Merge together
eez_amer <- rbind(eez_west, st_set_crs(st_transform(eez_east, "+proj=longlat +lon_wrap=-120"),
                                   st_crs(eez_west))) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for the Americas
americas_data <- maps_data |>
  filter(str_detect(region, "America")) |>
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in the Americas
  project(rast(ext(-200, 20, -60, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = amercent, show.legend = F),
                geom_sf(inherit.aes = F, data = eez_amer, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(-60, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- americas_data |>
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2041-2050")

#SSP5-8.5 2041-2050
p50_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2041-2050")

#SSP1-2.6 2091-2100
p00_126 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2091-2100")
  
#SSP5-8.5 2091-2100
p00_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2091-2100")+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(axis.title = element_blank(), plot.title = element_text(hjust = 0.5), 
        legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in American EEZs between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
americas_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                            labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
americas_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "americas_perc_change_map_50-00.pdf"), device = "pdf",
       width = 10, height = 9)
```
  
## Figure 7 FAO report - Oceania

```{r}
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, xmax = -120, ymax = 30)))
east <- st_crop(world, st_bbox(c(xmin = 60, ymin = -60, xmax = 180, ymax = 30)))
#Merge them together
oceancent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                              st_crs(east)), east)

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(str_detect(region, "Oceania")) |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = -120, ymax = 30)))
eez_east <- eez |> 
  filter(str_detect(region, "Oceania")) |> 
  st_crop(st_bbox(c(xmin = 60, ymin = -60, xmax = 180, ymax = 30)))
#Merge together
eez_ocean <- rbind(st_set_crs(st_transform(eez_west, "+proj=longlat +lon_wrap=180"), 
                              st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for the Americas
ocean_data <- maps_data |>
  filter(str_detect(region, "Oceania")) |>
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Europe
  project(rast(ext(60, 240, -60, 30), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = oceancent, show.legend = F),
                geom_sf(inherit.aes = F, data = eez_ocean, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ocean_data |>
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2041-2050")

#SSP5-8.5 2041-2050
p50_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2041-2050")

#SSP1-2.6 2091-2100
p00_126 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2091-2100")
  
#SSP5-8.5 2091-2100
p00_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2091-2100")+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, 
                             label.position = "bottom", nrow = 1))+
  theme(axis.title = element_blank(), plot.title = element_text(hjust = 0.5), 
        legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in Oceanian EEZs between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
oceania_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                            labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
oceania_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "oceania_perc_change_map_50-00.pdf"), device = "pdf",
       width = 10, height = 9)
```
  
## Figure 8 FAO report - Atlantic
  
```{r}
#FAO and EEZ shapefile
fao_eez_shp <- read_sf("../../Merged_FAO_EEZ/FAO_MajorAreas_EEZ.shp")

#Extract data for scenario, transform to raster and reproject
atlantic_data <- maps_data |> 
  filter(OCEAN == "Atlantic")
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                    type = scale_fill_custom, oob = scales::oob_squish),
                geom_sf(inherit.aes = F, data = world, show.legend = F),
                geom_sf(inherit.aes = F, data = fao_eez_shp[fao_eez_shp$OCEAN == "Atlantic",],
                        fill = NA, colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                lims(x = c(-80, 70), y = c(-60, 90)))

#SSP1-2.6 2041-2050
p50_126 <- atlantic_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2041-2050")

#SSP5-8.5 2041-2050
p50_585 <- atlantic_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2041-2050")

#SSP1-2.6 2091-2100
p00_126 <- atlantic_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP1-2.6: 2091-2100")
  
#SSP5-8.5 2091-2100
p00_585 <- atlantic_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  base_gg+
  labs(title = "SSP5-8.5: 2091-2100")+
  guides(fill = guide_legend(title = "% change", title.position = "top", 
                             title.hjust = 0.5, label.position = "bottom", 
                             nrow = 1))+
  theme(axis.title = element_blank(), plot.title = element_text(hjust = 0.5), 
        legend.spacing.x = unit(0, "cm"), legend.position = "bottom", 
        legend.direction = "horizontal", legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.75, "cm"))

#Get legend
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+theme(legend.position = "none")

#Create title for 
title <- ggdraw()+
  draw_label("Mean % change in fish biomass in FAO Atlantic regions between 2005-2014")+
  theme(plot.margin = margin(0, 0, 0, 0, unit = "cm"))

#Plotting everything together
atlantic_plots <- plot_grid(title, plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                        labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 4, 
                       rel_heights = c(0.15, 1, 1, 0.4))

#Check final map
atlantic_plots
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "atlantic_perc_change_map_50-00.pdf"), device = "pdf",
       width = 8, height = 9)
```


### Figure 9 FAO report - Pacific


### Figure 10 FAO report - Indian

### Figure 11 FAO report - Southern Ocean

### Figure 12 FAO report - Arctic

