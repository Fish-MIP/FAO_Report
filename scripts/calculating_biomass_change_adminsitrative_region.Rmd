---
title: "Temporal biomass change at the country level (country AND territories combined)"
author: "Gage"
date: "2024-01-17"
output: pdf_document
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  

 - We do this at the administrative/sovereign country level, rather than EEZ. For example, Macquarie Island is calculated as part of Australia. Norfolk Island is part of Australia. 
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
library(data.table)
#Raster data
library(terra)
#Combining plots
library(cowplot)
```

## Setting up notebook
This notebook uses a modified version of the Exclusive Economic Zones boundaries (version 11) from the [Flanders Marine Institute (2019)](https://doi.org/10.14284/386). Available [online](https://www.marineregions.org/). The following modifications were made:  
- Boundaries for South Georgia and Sandwich Islands were updated to boundaries provided by the UN  
- Boundaries around Bouvet Island (Norway) in the south Atlantic were added to this shapefile  
- Country boundaries were dissolved and polygons were reclassified by continent  
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

country_level_folder <- file.path(out_folder, "country_level_gage")
```
  
## Files with all information per grid cell
  
```{r}
#Getting GFDL grid area
area_gfdl_df <- list.files(out_folder, "gfdl-esm4_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()

#Getting IPSL grid area
area_ipsl_df <- list.files(out_folder, "ipsl-cm6a_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()


```


```{r}
#EEZ keys
# eez_keys <- read_csv("data/eez_keys_camilla.csv")

eez_keys <- read_csv(file.path(out_folder, "Merged_FAO_EEZ/supporting_files/EEZ_FAO_key.csv"))

filter(eez_keys, ISO3_country == "AUS") # 2 different id_merge (one for AU and the other for Macquarie island). Extraction of data by country through lat and lon will be done using id_mrq (eez specific) but grouping to calculate mean biomass will be done using fao_official (fao_country specific) so that both Au and mq island will fall under Au as per fao_official

#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()

```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
 - We do this at the country level rather than EEZ level 
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  
 # m = members[[1]]
  
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- area_ipsl_df
    print(paste0("processing '", m, "' file, using ipsl mask"))
  }else if(str_detect(m, "gfdl")){
    area_grid <- area_gfdl_df
    print(paste0("processing '", m, "' file, using gfdl mask"))
  }
  
  area_grid <- area_grid %>%
    mutate(Country_FAO = case_when(
      fao_official == "the Republic of Türkiye" ~ "Türkiye",
      fao_official == "the State of Libya" ~ "Libya", 
      fao_official == "the Republic of Côte d'Ivoire" ~ "Côte d'Ivoire",
      fao_official == "the Independent State of Papua New Guinea" ~ "Papua New Guinea", 
      fao_official == "the Commonwealth of Puerto Rico" ~ "the United States of America",
      fao_official == "the Republic of Cabo Verde" ~ "Cabo Verde",
      TRUE ~ Country_FAO
    ))
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |>
    map(~readRDS(.)) |>
    map_df(~bind_rows(.)) |>
    #Add area for each grid cell and area ID (FAO and EEZ)
    left_join(area_grid, by = join_by(x, y)) |>
    #Removing areas not recognised in FAO official name list
    drop_na(fao_official) |>
    #Calculate mean per ensemble member
    group_by(year, mem, esm, scenario, Country_FAO) |> 
    summarise(mean_bio = weighted.mean(biomass, cell_area, na.rm = T)) %>%
    ungroup()
  
  #Create name to save file
  f_out <- file.path(country_level_folder, str_c(m, "_yearly_perc_bio_change_admin.csv"))

  #Saving results for each model
  df_model |>
    fwrite(f_out)
}

```
  
## Calculating mean for reference period
Plots created here will show percentage change in biomass over time under two emissions scenarios: `SSP1-2.6` and `SSP5-8.5`. Our reference period is 2005-2014.  
  
```{r eval = F}
#Listing all relevant files to calculate biomass projections
bio_data <- list.files(country_level_folder, 
                       pattern = "_yearly_perc_bio_change_admin.csv",
                       full.names = T) |> 
  map_df(~fread(.)) %>%
  filter(Country_FAO != "")

unique(bio_data$Country_FAO) #148

#Calculating reference period
ref_bio <- bio_data |> 
  filter(year >= 2005 & year <= 2014) |> 
  #Calculate mean per ensemble member
  group_by(mem, esm, Country_FAO) |> 
  dplyr::summarise(ref_bio = mean(mean_bio, na.rm = T)) %>%
  ungroup()

# some are repetition if ID_mgr is removed 
fao_eez <-  eez_keys |>
  select(!ID_mrgd) |>
  distinct()
# nrow(fao_eez)

fao_eez <- fao_eez %>% 
  filter((is.na(continent) & is.na(Country_name))|(!is.na(continent) & !is.na(Country_name))) 
# nrow(fao_eez)

# calculate trends by model as needed for stat table 
bio_data_by_model <- bio_data |>
  #Add reference period to yearly biomass data
  left_join(ref_bio, by = c("mem", "esm", "Country_FAO")) |>
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) %>%
 select(-mean_bio, -ref_bio) 

#Check results
bio_data_by_model

bio_data <- bio_data |> 
  #Add reference period to yearly biomass data
  left_join(ref_bio, by = c("mem", "esm", "Country_FAO")) |> 
  #Calculate percentage change per model/year(scenario)/region
  mutate(perc_change = ((mean_bio-ref_bio)/ref_bio)*100) |> 
  #Calculate mean and standard deviation for percentage change 
  #per year(scenario)/region
  group_by(year, scenario, Country_FAO) |> 
  dplyr::summarise(mean_change = mean(perc_change, na.rm = T),
            sd_change = sd(perc_change, na.rm = T)) |> 
  #Add names in FAO-EEZ keys
  #left_join(fao_eez, by = c("Country_FAO" = "Country_name")) |> 
 ungroup() 
#%>%
 # mutate(fa_ffcl = ifelse(is.na(fa_ffcl), Country_FAO, fa_ffcl))

#Check results
bio_data

```
  
We can now save the results for future reference.  
  
```{r}
#Create name to save file
f_out <- file.path(country_level_folder, "ensemble_perc_bio_change_admin_all.csv")

#Saving results for each model
bio_data |>
  write_csv(f_out)

#Create name to save file
f_out <- file.path(country_level_folder, "mem_perc_bio_change_admin_all.csv")

#Saving results for each model
bio_data_by_model |>
  write_csv(f_out)

```
  
## Table of stats, model agreement and wilcox.test   

```{r}

### merge all info ----

bio_data_by_model <- bio_data_by_model %>% 
  mutate(spatial_scale = "countries_admin")

all_scale_data_by_model <- bio_data_by_model %>% 
  filter(year %in% c(2041:2050, 2091:2100)) %>% 
  mutate(decade = ifelse(year %in% c(2041:2050), "2041-2050", "2091-2100")) %>% 
  filter(!is.na(perc_change)) # some models do not output info on some countries (e.g. the Kingdom of Bahrain) as explored above. 

### mean, median, sd, min and max, agreement, wilcox ----
stats <- all_scale_data_by_model %>% 
  group_by(Country_FAO, mem, esm, scenario, decade, spatial_scale) %>% 
  summarise(mean_across_decade = mean(perc_change, na.rm = T)) %>%  # across decade to have one (mean) value of change per model and exclude temporal variability from the calculations below 
  ungroup() %>% 
  group_by(Country_FAO, scenario, decade, spatial_scale) %>% 
  summarise(
    mean = mean(mean_across_decade), # then across model 
    median = median(mean_across_decade),
    sd = sd(mean_across_decade),
    min = min(mean_across_decade),
    max = max(mean_across_decade),
    n_model = n(), # to calculate agreement again across models
    n_positive = sum(mean_across_decade>0),
    n_negative = sum(mean_across_decade<0), 
    same_sign = max(n_positive,n_negative),
    agreement = (same_sign/n_model)*100) %>% 
  ungroup()

# check 
filter(stats, Country_FAO == "the Republic of Albania")

stats <- stats %>% 
  select(-c(n_positive, n_negative, same_sign))

#### wilcox test ----
# http://www.sthda.com/english/wiki/unpaired-two-samples-wilcoxon-test-in-r
# from example: The p-value of the test is 0.02712, which is less than the significance level alpha = 0.05. We can conclude that men’s median weight is significantly different from women’s median weight with a p-value = 0.02712.

w_test <- all_scale_data_by_model %>% 
  spread(scenario, perc_change) %>% 
  group_by(Country_FAO, decade, spatial_scale) %>%
  summarise(wilcox_p = wilcox.test(ssp126, ssp585, alternative = "two.sided")$p.value) %>% 
  ungroup()

table <- stats %>% 
  full_join(w_test)


fwrite(table, paste0(country_level_folder,"/table_stats.csv"))
fwrite(table, here("data/table_stats_country_admin.csv"))

test <- read_csv(file.path(out_folder, "table_stats.csv"))


```
