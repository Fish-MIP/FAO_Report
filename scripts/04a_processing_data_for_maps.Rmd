---
title: "Processing biomass data to create maps of biomass change"
author: "Denisse Fierro Arcos"
date: "2024-04-23"
output: pdf_document
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
library(readxl)
#Data wrangling
library(tidyverse)
library(data.table)
library(janitor)
#Dealing with raster data
library(terra)
```

## Getting area of grid cells for IPSL and GFDL
  
```{r}
#Location of area grid files
area_grid <- "/rd/gem/private/shared_resources/grid_cell_area_ESMs/isimip3b/"

#Getting GFDL grid area
area_gfdl <- rast(list.files(area_grid, "gfdl", full.names = T))
#Change land values from 0 to NA
area_gfdl[area_gfdl == 0] <- NA
#Transform to data frame
area_gfdl_df <- area_gfdl |> 
  as.data.frame(xy = T)

#Getting IPSL grid area
area_ipsl <- rast(list.files(area_grid, "ipsl", full.names = T))
#Transform to data frame
area_ipsl_df <- area_ipsl |> 
  as.data.frame(xy = T)
```
  
## Getting FAO-EEZ information
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

#FAO_EEZ keys - Contains continent information
fao_eez <- read_csv(list.files(out_folder, pattern = "_keys.csv", 
                               full.names = T, recursive = T))

#FAO_EEZ mask - Contains IDs for FAO and EEZ areas
fao_eez_mask <- read_csv(list.files(out_folder, 
                                    pattern = "^masked_area_1deg.csv", 
                                    full.names = T, recursive = T)) |> 
  rename(x = Lon, y = Lat, ID_mrgd = mask)

#Merging masks and area files into a single variable
fao_eez_mask <- fao_eez |> 
  select(ID_mrgd, nm_mrgd, NAME_EN, CONTINENT) |> 
  right_join(fao_eez_mask, by = join_by("ID_mrgd")) |> 
  left_join(area_gfdl_df, by = join_by("x", "y")) |> 
  rename(gfdl = areacello) |> 
  left_join(area_ipsl_df, by = join_by("x", "y")) |> 
  rename(ipsl = cell_area)
```
  
## Getting a list of FishMIP biomass outputs
  
```{r}
#Getting a list of files containing biomass data
global_files <- list.files(base_folder, pattern = "global_10g-100kg.rds", 
                           full.names = T, recursive = T)

#Getting a list of models
members <- str_extract(global_files, "annual_(.*)_(h|s)", group = 1) |> 
  unique()
```
  
## Calculating percentage change in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the mean fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Looping through each FishMIP model
for(m in members){
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Extract data only for years to be used in maps
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #Group column also needs to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, 
                                                          sep = "_"),
                             T ~ group)) |> 
    #Apply mask
    left_join(fao_eez_mask, by = join_by(x, y)) |> 
    #Calculate mean per ensemble member
    group_by(x, y, mem, esm, ID_mrgd, group) |> 
    summarise(mean_bio = mean(biomass, na.rm = T)) |> 
    #Reorganise table to facilitate calculations
    pivot_wider(names_from = group, values_from = mean_bio) |> 
    ungroup() |> 
    #Calculate % change in fish biomass for the two emissions scenarios
    mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
           rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
           rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
           rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)
  
  #Create name to save file  
  f_out <- file.path(out_folder, str_c(m, "_perc_bio_change_data_map.csv"))
  
  #Saving results for each model
  df_model |> 
    fwrite(f_out)
}
```
  
## Calculating FishMIP ensemble fish biomass
We will now load the percentage change in biomass for all global models and calculate an ensemble mean.  
  
```{r}
#Listing all relevant files to calculate biomass projections
maps_data <- list.files(out_folder, pattern = "_perc_bio_change_data_map.csv", 
                        full.names = T) |> 
  map_df(~fread(.)) |> 
  #Calculations performed by year and EEZ
  group_by(x, y, ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(reference:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(mean = mean), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup() |> 
  #Add information about continents
  inner_join(fao_eez_mask, by = join_by(x, y, ID_mrgd)) |> 
  #If a grid cell is not assigned to an EEZ, then change to NA
  mutate(across(starts_with("rel_change"), ~ case_when(is.na(ID_mrgd) ~ NA,
                                                      T ~ .x)))

#Save ensemble data
maps_data |> 
  write_csv("../data/ensemble_perc_bio_change_data_map.csv")
```
    
## Calculating annual fisheries catch
We will calculate the yearly mean capture fisheries production per country (2012-2021). Capture fisheries production data comes from the [FAO's Fisheries and Aquaculture Data Portal](https://www.fao.org/fishery/statistics-query/en/global_production/global_production_quantity).  
  
```{r, eval = F}
#Load fisheries data
fisheries_catch <- list.files(out_folder,
                              pattern = "raw_FishStatJ.xlsx",
                              full.name = T) |>
  read_excel() |> 
  #Simplify column names
  clean_names() |> 
  #Keep only rows in tonnes
  filter(str_detect(unit_name, "Tonne"))

#Getting list of years from column names
years <- str_subset(names(fisheries_catch), "^x.*")
#Getting list of flags from column names
years_flag <- str_subset(names(fisheries_catch), "^s.*")

#Create new variable to store clean data
fisheries_catch_clean <- fisheries_catch |> 
  select(country_name)

#Loop through each year
for(i in seq_along(years)){
  #Select columns for year and flags for that year
  clean <- fisheries_catch |> 
    #Both columns have the same index
    select(c(years[i], years_flag[i]))
  #Chang column names so it is easy to identify them
  names(clean) <- c("year", "flag")
  #Change year row to NA if there is an "E" or "..." in the flag column
  clean <- clean |> 
    mutate(year = case_when(flag == "E" | flag == "..." ~ NA,
                            T ~ year))
  #Change column names back to original
  colnames(clean) <- c(years[i], years_flag[i])
  #Bind clean columns to new variable
  fisheries_catch_clean <- fisheries_catch_clean |> 
    bind_cols(clean)
}

#Reorganise data prior to plotting
fisheries_catch_clean <- fisheries_catch_clean |> 
  #Remove flag columns and year 2022
  select(!c(starts_with("s_")|x2022)) |> 
  #Reorganise data
  pivot_longer(!country_name, names_to = "year", names_prefix = "x", 
               values_to = "annual_catch_tonnes") |> 
  #Renaming countries that include regions within countries
  mutate(country_name = case_when(str_detect(country_name, "Tanzania") ~
                                    "United Republic of Tanzania",
                                    T ~ country_name)) |> 
  #Add rows with the same country name
  group_by(country_name, year) |> 
  summarise(annual_catch_tonnes = sum(annual_catch_tonnes, na.rm = T))

#Fisheries data does not contain identifiers for countries, we will match
#the above summary to the country ISO codes from the FAO
fao_countries <- list.files(out_folder, pattern = "FAO_countries_list", 
                            full.names = T) |> 
  read_excel(sheet = "Codes") |> 
  #Simplify column names
  clean_names() |> 
  #Select columns of interest
  select(list_name, iso3)

#Checking FishStatsJ countries against FAO approved list
fishstat_countries <- fisheries_catch_clean |> 
  distinct(country_name) |> 
  pull(country_name)
fao_count <- fao_countries |> 
  distinct(list_name) |> 
  pull(list_name)
#Countries to be removed
remove_countries <- fishstat_countries[!fishstat_countries %in% fao_count]

fisheries_catch_clean <- fisheries_catch_clean |> 
  #Removing countries that are not recognised by FAO
  ungroup() |> 
  filter(!country_name %in% remove_countries) |> 
  group_by(country_name) |> 
  #Dividing by 1,000,000 to show data in maps as millions of tonnes
  summarise(mean_annual_catch = mean(annual_catch_tonnes, na.rm = T)*1e-6) |> 
  #Create new column with classification
  mutate(class_fish = cut(mean_annual_catch, 
                          #Including a small negative number to include 
                          #countries with 0 values in first group
                          breaks = c(-1e-6, .25, 1, 2, 4, 6, 20),
                          labels = c("<0.25", "0.25-1", "1-2", "2-4", "4-6", 
                                     ">6")))

#Add ISO codes to fisheries data
fisheries_catch_clean <- fisheries_catch_clean |> 
  left_join(fao_countries, by = c("country_name" = "list_name")) |> 
  #Remove country name
  select(!country_name) |> 
  #Renaming ISO code column to match world map name
  rename(ISO3CD = iso3)

#Saving clean fisheries catch data
fisheries_catch_clean |> 
  write_csv("../data/world_mean_annual_catch.csv")
```
  
## Calculating percentage difference in human populations 
  
```{r}
#Population change data
pop_sum <- function(file){
  df <- read_csv(file, skip = 4) |> 
    #Reorganise data calculate relative change
    pivot_longer(!c(iso, country), names_to = "year", 
                 values_to = "population") |> 
    mutate(year = as.numeric(year)) |> 
    #Keep only relevant years
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(scenario = str_extract(file, "population_(.*)_nat", group = 1),
           group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #The new group column also need to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, 
                                                          sep = "_"),
                             T ~ group)) |> 
    #Calculate mean population per country and group
    group_by(iso, country, group) |> 
    summarise(mean_pop = mean(population, na.rm = T))
}

#Apply function to all relevant files
pop_change <- list.files("../data/", pattern = "national_annual", 
                         full.names = T) |> 
  map(~pop_sum(.)) |> 
  #Join all data frames
  map_df(~bind_rows(.)) |> 
  #Reorganise data
  pivot_wider(names_from = group, values_from = mean_pop) |> 
  ungroup() |> 
  #Renaming ISO code to match world data
  rename(ISO3CD = iso) |> 
  #Calculate % change in fish biomass for the two emissions scenarios
  mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
         rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
         rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
         rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)

#Save results 
pop_change |> 
  write_csv("../data/world_population_change.csv")
```
    
## Calculating biomass change by FAO region
The ESMs used to force the FishMIP models vary slightly, so different area of grid cell will be used to calculate weighted biomass.  
  
```{r}
#Looping through each FishMIP model
for(m in members){
  #Select correct area of grid cell
  if(str_detect(m, "ipsl")){
    area_grid <- fao_eez_mask |> 
      select(!gfdl) |> 
      #rename column
      rename(area_m = ipsl)
  }else if(str_detect(m, "gfdl")){
    area_grid <- fao_eez_mask |> 
      select(!ipsl)|> 
      #rename column
      rename(area_m = gfdl)
  }
  
  #Load all data available for a single FishMIP model
  df_model <- str_subset(global_files, m) |> 
    map(~readRDS(.)) |> 
    map_df(~bind_rows(.)) |> 
    #Extract data only for years to be used in maps
    filter(year >= 2005 & year <= 2014 | year >= 2041 & year <= 2050 | year >= 2091 & year <= 2100) |> 
    #Create new group column to calculate means
    mutate(group = case_when(year <= 2014 ~ "reference",
                             year >= 2041 & year <= 2050 ~ "mean50",
                             year >= 2091 & year <= 2100 ~ "mean00"),
           #Group column needs to have the scenario as part of the label
           group = case_when(group != "reference" ~ str_c(group, scenario, 
                                                          sep = "_"),
                             T ~ group)) |> 
    #Apply mask
    left_join(area_grid, by = join_by(x, y)) |> 
    #Calculate mean per ensemble member per year
    group_by(year, mem, esm, ID_mrgd, group) |> 
    summarise(mean_bio = weighted.mean(biomass, area_m, na.rm = T)) |> 
    #Calculate mean per ensemble member per period
    group_by(mem, esm, ID_mrgd, group) |> 
    summarise(mean_bio = mean(mean_bio, na.rm = T)) |> 
    #Reorganise table to facilitate calculations
    pivot_wider(names_from = group, values_from = mean_bio) |> 
    ungroup() |> 
    #Calculate % change in fish biomass for the two emissions scenarios
    mutate(rel_change_mean50_ssp126 = ((mean50_ssp126-reference)/reference)*100,
           rel_change_mean50_ssp585 = ((mean50_ssp585-reference)/reference)*100,
           rel_change_mean00_ssp126 = ((mean00_ssp126-reference)/reference)*100,
           rel_change_mean00_ssp585 = ((mean00_ssp585-reference)/reference)*100)
  
  #Create name to save file  
  f_out <- file.path(out_folder, str_c(m, "_perc_bio_change_choro_map.csv"))
  
  #Saving results for each model
  df_model |> 
    fwrite(f_out)
}
```
  
We will compile the results of the model outputs processing above in a single file. We will also rearrange the data in preparation for plotting. Finally, we will apply a Robinson projection for mapping.  
  
```{r}
#Listing all relevant files to calculate biomass projections
fao_map_data <- list.files(out_folder,
                           pattern = "_perc_bio_change_choro_map.csv", 
                           full.names = T) |> 
  map_df(~fread(.)) |> 
  drop_na(ID_mrgd) |> 
  #Calculations performed by year and EEZ
  group_by(ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(rel_change_mean50_ssp126:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(mean = mean), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup()

#Save ensemble data
fao_map_data |> 
  write_csv("../data/ensemble_perc_bio_change_fao_map.csv")
```
  
## Calculating proportion of sustainable fisheries by country
We will use FAO data for 2019 because it is the most recently data available.  
  
```{r}
#Loading FAO fisheries data
fao_fisheries <- read_csv(list.files(out_folder, 
                                     pattern = "FAO_fisheries_data.csv",
                                     full.names = T, recursive = T), 
                          #Keeping only relevant columns
                          col_select = c("GEO_AREA_NAME", "OBS_VALUE")) |>
  #Renaming column to match other FAO data
  rename(NAME_EN = GEO_AREA_NAME) |> 
  #We will simplify the names of the regions to merge with our FAO data
  mutate(NAME_EN = str_remove(NAME_EN, "FAO Major Fishing Area: "))

#Save results
fao_fisheries |> 
  write_csv("../data/prop_sustainable_fisheries_fao.csv")
```
  
## Calculating standard deviation in fish biomass estimates from global FishMIP models
We will go through each FishMIP model and calculate the standard deviation for fish biomass for the decade between 2005 and 2014 (last decade of `historical` period), and for the period between 2041 and 2050 (for the two emission scenarios), and between 2091 and 2100 (two scenarios). Finally, we will calculate the percentage change between these two decades.  
  
```{r, eval = F}
#Listing all relevant files to calculate biomass projections
maps_data_sd <- list.files(out_folder, 
                           pattern = "_perc_bio_change_data_map.csv", 
                           full.names = T) |> 
  map_df(~fread(.)) |> 
  #Calculations performed by year and EEZ
  group_by(x, y, ID_mrgd) |> 
  #Apply calculations to biases only
  summarise(across(rel_change_mean50_ssp126:rel_change_mean00_ssp585, 
                   #Listing statistics to be calculated
                   list(sd = sd), 
                   #Setting column names
                   .names = "{.col}_{.fn}")) |> 
  ungroup()

#Save results
maps_data_sd |> 
  write_csv("../data/ensemble_sd_bio_change_data_map.csv")
```
