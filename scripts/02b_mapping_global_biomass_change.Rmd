---
title: "Plotting biomass change under different SSPs"
author: "Denisse Fierro Arcos"
date: "2024-01-09"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Introduction

In this notebook, we will calculate the mean percentage change in fish biomass between 2041 and 2050 under two climate emission scenarios: `SSP1-2.6` (low emissions) and `SSP5-8.5` (very high emissions). The last decade from the historical period (2005-2014) was used as the reference period.  
  
Note that outputs from all [global FishMIP models](https://fishmip.org/modellingteams.html) were used to calculate the mean percentage change for the entire ensemble.  
  
## Loading libraries
  
```{r, message=FALSE, warning=FALSE}
#Data wrangling
library(tidyverse)
#Using more than one scale in plots
library(ggnewscale)
#Dealing with raster data
library(terra)
library(tidyterra)
#Dealing with vector data
library(sf)
#Base maps
library(rnaturalearth)
#Color palettes
library(cmocean)
library(scales)
#Combining plots
library(cowplot)
```

## Setting up notebook
This notebook uses a modified version of the Exclusive Economic Zones boundaries (version 11) from the [Flanders Marine Institute (2019)](https://doi.org/10.14284/386). Available [online](https://www.marineregions.org/). The following modifications were made:  
- Boundaries for South Georgia and Sandwich Islands were updated to boundaries provided by the UN  
- Boundaries around Bouvet Island (Norway) in the south Atlantic were added to this shapefile  
- Country boundaries were dissolved and polygons were reclassified by continent  
  
```{r}
#Base folder for project
base_folder <- "/rd/gem/private/users/camillan"

#Defining location of notebook outputs
out_folder <- file.path(base_folder, "FAO_Report")
if(!dir.exists(out_folder)){
  dir.create(out_folder)
}

#Getting GFDL grid area
area_gfdl_df <- list.files(out_folder, "gfdl-esm4_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()

#Getting IPSL grid area
area_ipsl_df <- list.files(out_folder, "ipsl-cm6a_60arcmin_global_FAO-EEZ.csv",
                           recursive = T, full.names = T) |> 
  read_csv()
```
  
## Loading relevant shapefiles
We will apply a Robinson projection to all shapefiles before plotting them.  
  
```{r}
#Robinson projection
rob_proj <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs
+type=crs"

#Unprojected UN-approved world base map
world <- read_sf(list.files(out_folder, pattern = "country_bounds.shp",
                            full.names = T, recursive = T))

#Base map
world_proj <- world |> 
  st_transform(rob_proj)

#Boundaries provided by UN
world_bound <- read_sf(list.files(out_folder, pattern = "UN_intbnd.shp", 
                                        full.names = T, recursive = T)) |> 
  #Selecting boundary types to be included in the map
  filter(TYPE < 99) 

#Boundaries provided by UN
world_bound_proj <- world_bound |> 
  st_transform(rob_proj)

#FAO and EEZ boundaries - unprojected
fao_eez <- read_sf(list.files(out_folder, 
                               pattern = "FAO_MajorAreas_200NM.shp", 
                               recursive = T, full.names = T))

#FAO - EEZ boundaries - projected
fao_eez_proj <- fao_eez |> 
   st_transform(rob_proj)

#EEZ boundaries - unprojected
eez <- fao_eez |> 
  filter(is.na(NAME_EN)) |> 
  #Removing empty columns
  select(!NAME_EN)

#EEZ boundaries - projected
eez_proj <- eez |> 
   st_transform(rob_proj)

#FAO regions 
fao_proj <- fao_eez_proj |>
  drop_na(NAME_EN) |> 
  #Removing empty columns
  select(!continent)
```
  
## Figure 2 FAO report - Regions used in report
FAO regions are coloured by ocean basin, and EEZs are classified by continent.  
  
```{r}
main <- ggplot()+
  #Plotting FAO classified by ocean basin
  geom_sf(data = fao_proj, aes(fill = nm_mrgd))+
  #Plotting EEZ classified by continent
  geom_sf(data = eez_proj, aes(fill = continent))+
  #Using colour blind friendly colours
  scale_fill_manual(values = c("Pacific" = "#222255", "Atlantic" = "#225555", 
                               "Indian" = "#225522", "Arctic" = "#666633", 
                               "Oceania" = "#bbccee", "Europe" = "#cceeff", 
                               "Americas" = "#ccddaa", "Africa" = "#eeeebb",
                               "Southern Ocean" = "#663333", 
                               "Asia" = "#ffcccc"))+
  #Plotting base map and country boundaries
  geom_sf(data = world_proj, color = "#dbdade", fill = "#dbdade")+
  #Adding coastlines and international boundaries
  geom_sf(data = world_bound_proj, lwd = 0.25, color = "black", show.legend = F, 
          aes(linetype = as.factor(TYPE)))+
  scale_linetype_manual(values = c("0" = "solid", "1" = "twodash", 
                                   "2" = "dotdash", "3" = "dashed", 
                                   "4" = "dotted"))+
  geom_sf(data = world_bound_proj[world_bound_proj$TYPE == 8,], 
          linetype = "longdash", 
          lwd = 0.25, color = "#838285", show.legend = F)+
  #Removing grey background
  theme_bw()+
  #Formatting legend title
  guides(fill = guide_legend(title = "FAO and EEZ classification", 
                             title.position = "top", title.hjust = 0.5))+
  #Formatting legend
  theme(legend.position = "bottom", panel.border = element_rect(colour = NA),
        legend.margin = margin(0, 0, 0, 0), 
        legend.box.margin = margin(0, 0, 0, 0),
        legend.title = element_text(size = 13), 
        legend.text = element_text(size = 13))
```
  
Saving map showing FAO regions and EEZs classified by continent.  
  
```{r, eval = F}
ggsave(filename = file.path(out_folder, "fao_eez_global_map.pdf"), main,
       device = "pdf", width = 14, height = 9)
```
  
## Figure 3 FAO report - Percentage change per decade and scenario.
In this figure, we will show percentage fish biomass change in the ocean, while yearly mean capture fisheries production per country (2012-2021) will be shown on land.

Capture fisheries production data comes from the [FAO's Fisheries and Aquaculture Data Portal](https://www.fao.org/fishery/statistics-query/en/global_production/global_production_quantity). 
  
```{r}
#Load fisheries data
fisheries_catch <- read_csv("data/world_mean_annual_catch.csv") |> 
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))

#Now we can add this information to the world maps
#Projected
world_proj <- world_proj |> 
  left_join(fisheries_catch, by = join_by(ISO3CD))

#Unprojected
world <- world |> 
  left_join(fisheries_catch, by = join_by(ISO3CD))
```
  
We will transform the data frame containing the percentage change into a multi-layer raster, and apply a Robinson projection.   
  
```{r}
#Loading ensemble biomass change
maps_data <- read_csv("data/ensemble_perc_bio_change_data_map.csv")

#Extract data for scenario, transform to raster and reproject
maps_data_proj <- maps_data |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, starts_with("rel_change")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```
  
We will also create a custom-made colour palette for the maps.  
  
```{r}
#Create custom-made color palette
scale_fill_custom <- function(..., alpha = 1, begin = 0, end = 1, direction = 1,
                              option = "D", values = NULL, space = "Lab", 
                              na.value = "white", guide = "colourbar", 
                              aesthetics = "fill") {
  continuous_scale(aesthetics, scale_name = "custom",
                   palette = gradient_n_pal(c(cmocean("matter", start = 0.1, 
                                                      end = 0.8, 
                                                      direction = -1)(123),
                                              cmocean("delta", start = 0.49, 
                                                      end = 0.5)(20),
                                              cmocean("deep", start = 0.1, 
                                                      end = 0.8)(123)), values,
                                            space), 
                   na.value = na.value, guide = guide, ...)
}
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                                  type = scale_fill_custom,
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = world_proj, color = NA, 
                        aes(fill = class_fish), show.legend = F),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_proj, lwd = 0.25, 
                        color = "black", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$ISO3_CNT1 == "ATA",],
                        lwd = 0.25, linetype = "solid", color = "#5b5b5b", 
                        show.legend = F),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA,
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#Plotting land masses to get legend
land <- ggplot()+
  geom_sf(data = world_proj, aes(fill = class_fish))+
  scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc", 
                    name = "Yearly landings between 2012-2021 (million tonnes)",
                    labels = c("<0.25", "0.25-1", "1-2", "2-4", "4-6", ">6",
                               "No data"))+
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5, 
                             barwidth = 15, 
                             label.position = "bottom", nrow = 1, 
                             keywidth = unit(1.25, "cm"), label.hjust = 0.5))+
  theme(legend.position = "bottom")

#Get legend for land
leg_land <- get_legend(land)

#Plotting fish biomass to get legend
fish <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp126_mean)+
  scale_fill_binned(limits = c(-50, 50), n.breaks = 8, oob = oob_squish, 
                    type = scale_fill_custom, 
                    name = "% change in fish biomass")+
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")

#Get legend for land
leg_fish <- get_legend(fish)

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp126_mean)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean50_ssp585_mean)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp126_mean)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_proj$rel_change_mean00_ssp585_mean)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
all_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                 labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                       ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_perc_change_map_50-00.pdf"), all_plots,
       device = "pdf", width = 14, height = 8)
```
  
## Figure 5 FAO report - Asia 
  
```{r}
#Extracting data for Asia
asia_data <- maps_data |> 
  filter(continent == "Asia")

#Selecting Asian countries
asia_cent <- world |> 
  st_crop(st_bbox(c(xmin = 20, ymin = -20, xmax = 165, ymax = 55))) |> 
  #Add empty row to add >6 "fish class"
  add_row(class_fish = "4-6", CONTCD = "ASI") |> 
  #Ensure classes are ordered prior to plotting
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))
```
    
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                                  type = scale_fill_custom,
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = eez[eez$continent == "Asia",], 
                         fill = NA, colour = "#5b5b5b", show.legend = F,
                         linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = asia_cent[asia_cent$CONTCD == "ASI",], 
                        color = NA, aes(fill = class_fish), show.legend = F),
                geom_sf(inherit.aes = F, 
                        data = asia_cent[asia_cent$CONTCD != "ASI",], 
                        color = "#dbdade", fill = "#dbdade"),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_proj, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$ISO3_CNT1 == "ATA",],
                        lwd = 0.25, linetype = "solid", color = "#5b5b5b", 
                        show.legend = F),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                lims(x = c(25, 160), y = c(-15, 50)))

#SSP1-2.6 2041-2050
p50_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- asia_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
asia_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                  labels = c("a", "b"), label_x = 0.1),
                        plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                  labels = c("c", "d"), label_x = 0.1),
                        #Using legends from Figure 3
                        plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                        ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variable
rm(asia_cent)
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "asia_perc_change_map_50-00.pdf"), asia_plots, 
       device = "pdf", width = 14, height = 8)
```
  
## Figure 7 FAO report - Americas
As we did with Europe, we would like the Americas to show in the middle of the map, so we will have to pre-process our data before plotting the maps.  
  
```{r}
sf_use_s2(F)
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = 20, ymax = 90)))
east <- st_crop(world, st_bbox(c(xmin = 160, ymin = -60, 
                                 xmax = 180, ymax = 90)))
#Merge them together
amercent <- rbind(west, 
                  st_set_crs(st_transform(east, 
                                          "+proj=longlat +lon_wrap=-120"),
                             st_crs(west))) |> 
  #Add empty row to add >6 "fish class"
  add_row(class_fish = ">6", CONTCD = "AME") |> 
  #Ensure classes are ordered prior to plotting
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))

#Split world boundaries in two hemispheres 
west <- st_crop(world_bound, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = 20, ymax = 90)))
east <- st_crop(world_bound, st_bbox(c(xmin = 160, ymin = -60, 
                                 xmax = 180, ymax = 90)))
#Merge them together
amercent_bound <- rbind(west, 
                        st_set_crs(st_transform(east, 
                                                "+proj=longlat +lon_wrap=-120"),
                                   st_crs(west))) 

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(continent == "Americas") |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = 20, ymax = 90)))
eez_east <- eez |> 
  filter(continent == "Americas") |> 
  st_crop(st_bbox(c(xmin = 160, ymin = -60, xmax = 180, ymax = 90)))
#Merge together
eez_amer <- rbind(eez_west,
                  st_set_crs(st_transform(eez_east, 
                                          "+proj=longlat +lon_wrap=-120"),
                             st_crs(eez_west))) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for the Americas
americas_data <- maps_data |>
  filter(continent == "Americas") |> 
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in the Americas
  project(rast(ext(-200, 20, -60, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = eez_amer, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                         data = amercent[amercent$CONTCD == "AME",], 
                         aes(fill = class_fish), colour = NA),
                geom_sf(inherit.aes = F, 
                        data = amercent[amercent$CONTCD != "AME",],
                        color = "#dbdade", fill = "#dbdade"),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = amercent_bound, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = amercent_bound[amercent_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(-60, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- americas_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
americas_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                      labels = c("a", "b"), label_x = 0.1),
                            plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                      labels = c("c", "d"), label_x = 0.1),
                            #Using legends from Figure 3
                            plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                            ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(amercent, amercent_bound, eez_amer)
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "americas_perc_change_map_50-00.pdf"), 
       americas_plots, device = "pdf", width = 10, height = 9)
```  
  
## Figure 9 FAO report - Europe
Since we want to show Europe in the middle of the map, we will have to project our data and split the base map in two hemispheres.  
  
```{r}
#Split world in two hemispheres
east <- st_crop(world, st_bbox(c(xmin = -50, ymin = 20, 
                                 xmax = 180, ymax = 90)))
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = 20, 
                                 xmax = -150, ymax = 90)))
#Merge them together
eurocent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                             st_crs(east)), east) |> 
  #Add empty row to add >6 "fish class"
  add_row(class_fish = ">6", CONTCD = "EUR") |> 
  #Ensure classes are ordered prior to plotting
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))

#Split world boundaries in two hemispheres
east <- st_crop(world_bound, st_bbox(c(xmin = -50, ymin = 20, 
                                 xmax = 180, ymax = 90)))
west <- st_crop(world_bound, st_bbox(c(xmin = -180, ymin = 20, 
                                 xmax = -150, ymax = 90)))
#Merge them together
eurocent_bound <- rbind(st_set_crs(st_transform(west, 
                                                "+proj=longlat +lon_wrap=180"), 
                             st_crs(east)), east) 

#Split EEZ in two hemispheres
eez_east <- st_crop(eez[eez$continent == "Europe",], 
                    st_bbox(c(xmin = -50, ymin = 20, xmax = 180, ymax = 90)))
eez_west <- st_crop(eez[eez$continent == "Europe",], 
                    st_bbox(c(xmin = -180, ymin = 20, xmax = -150, ymax = 90)))
#Merge together
eez_euro <- rbind(st_set_crs(st_transform(eez_west, 
                                          "+proj=longlat +lon_wrap=180"), 
                             st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for Europe
europe_data <- maps_data |>
  filter(continent == "Europe") |> 
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Europe
  project(rast(ext(-50, 210, 20, 90), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = eez_euro, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                 geom_sf(inherit.aes = F, 
                         data = eurocent[eurocent$CONTCD == "EUR",], 
                         aes(fill = class_fish), colour = NA),
                geom_sf(inherit.aes = F, 
                        data = eurocent[eurocent$CONTCD != "EUR",],
                        color = "#dbdade", fill = "#dbdade"),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = eurocent_bound, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = eurocent_bound[eurocent_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                coord_sf(ylim = c(23, 87), expand = F))

#SSP1-2.6 2041-2050
p50_126 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- europe_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
europe_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                    labels = c("a", "b"), label_x = 0.1),
                          plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                    labels = c("c", "d"), label_x = 0.1),
                          #Using legends from Figure 3
                          plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                          ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(eez_euro, eurocent, eurocent_bound)
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "europe_perc_change_map_50-00.pdf"),
       europe_plots, device = "pdf", width = 10, height = 6)
```
  
## Figure 11 FAO report - Africa
  
```{r}
#Extract data for scenario, transform to raster and reproject
africa_data <- maps_data |> 
  filter(continent == "AFR")

#Selecting African countries
africa_cent <- world |> 
  st_crop(st_bbox(c(xmin = -35, ymin = -60, xmax = 90, ymax = 45))) |> 
  #Add empty row to add 2-4 "fish class"
  add_row(class_fish = "2-4", CONTCD = "AFR") |> 
  #Add empty row to add 4-6 "fish class"
  add_row(class_fish = "4-6", CONTCD = "AFR") |> 
  #Add empty row to add >6 "fish class"
  add_row(class_fish = ">6", CONTCD = "AFR") |> 
  #Ensure classes are ordered prior to plotting
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = eez[eez$continent == "Africa",], 
                         fill = NA, colour = "#5b5b5b", show.legend = F,
                         linewidth = 0.25),
                geom_sf(inherit.aes = F, 
                        data = africa_cent[africa_cent$CONTCD == "AFR",], 
                        color = NA, aes(fill = class_fish), show.legend = F),
                geom_sf(inherit.aes = F, 
                        data = africa_cent[africa_cent$CONTCD != "AFR",], 
                        color = "#dbdade", fill = "#dbdade"),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound[world_bound$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"),
                lims(x = c(-29, 85), y = c(-55, 40)))

#SSP1-2.6 2041-2050
p50_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- africa_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
africa_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                    labels = c("a", "b"), label_x = 0.1),
                          plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                    labels = c("c", "d"), label_x = 0.1),
                          #Using legends from Figure 3
                          plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                          ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variable not needed
rm(africa_cent)
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "africa_perc_change_map_50-00.pdf"),
       africa_plots, device = "pdf", width = 9, height = 9)
```
  
## Figure 13 FAO report - Oceania

```{r}
#Split world in two hemispheres 
west <- st_crop(world, st_bbox(c(xmin = -180, ymin = -60, 
                                 xmax = -100, ymax = 30)))
east <- st_crop(world, st_bbox(c(xmin = 60, ymin = -60, 
                                 xmax = 180, ymax = 30)))
#Merge them together
oceancent <- rbind(st_set_crs(st_transform(west, "+proj=longlat +lon_wrap=180"), 
                              st_crs(east)), east) |> 
  #Add empty row to add 2-4 "fish class"
  add_row(class_fish = "1-2", CONTCD = "OCE") |> 
  #Add empty row to add 2-4 "fish class"
  add_row(class_fish = "2-4", CONTCD = "OCE") |> 
  #Add empty row to add 4-6 "fish class"
  add_row(class_fish = "4-6", CONTCD = "OCE") |> 
  #Add empty row to add >6 "fish class"
  add_row(class_fish = ">6", CONTCD = "OCE") |> 
  #Ensure classes are ordered prior to plotting
  mutate(class_fish = factor(class_fish, 
                             levels = c("<0.25", "0.25-1", "1-2", "2-4", 
                                        "4-6", ">6"), ordered = T))

#Split world boundaries in two hemispheres 
west <- st_crop(world_bound, st_bbox(c(xmin = -180, ymin = -60, 
                                             xmax = -100, ymax = 30)))
east <- st_crop(world_bound, st_bbox(c(xmin = 60, ymin = -60, 
                                             xmax = 180, ymax = 30)))
#Merge them together
oceancent_bound <- rbind(st_set_crs(st_transform(west, 
                                                 "+proj=longlat +lon_wrap=180"),
                                    st_crs(east)), east)

#Split EEZ in two hemispheres
eez_west <- eez |> 
  filter(continent == "Oceania") |> 
  st_crop(st_bbox(c(xmin = -180, ymin = -60, xmax = -100, ymax = 30)))
eez_east <- eez |> 
  filter(continent == "Oceania") |> 
  st_crop(st_bbox(c(xmin = 60, ymin = -60, xmax = 180, ymax = 30)))
#Merge together
eez_ocean <- rbind(st_set_crs(st_transform(eez_west, 
                                           "+proj=longlat +lon_wrap=180"), 
                              st_crs(eez_east)), eez_east) 

#Removing variables that are not needed
rm(eez_east, eez_west, east, west)

#Extracting data for Oceania
ocean_data <- maps_data |>
  filter(continent == "Oceania") |>
  #Selecting relevant columns
  select(x, y, starts_with("rel_change")) |> 
  #Converting to raster
  rast(crs = "epsg:4326") |> 
  #Reprojecting so raster is centered in Oceania
  project(rast(ext(60, 260, -60, 30), res = 1)) |> 
  #Return to data frame
  as.data.frame(xy = T)
```
  
We will plot each decade/scenario combination separately and then create a multi-panel figure with all maps.  
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8, 
                                  type = scale_fill_custom, 
                                  oob = oob_squish),
                new_scale_fill(),
                geom_sf(inherit.aes = F, data = eez_ocean, fill = NA, 
                        colour = "#5b5b5b", show.legend = F, linewidth = 0.25),
                 geom_sf(inherit.aes = F, 
                         data = oceancent[oceancent$CONTCD == "OCE",], 
                         aes(fill = class_fish), colour = NA),
                geom_sf(inherit.aes = F, 
                        data = oceancent[oceancent$CONTCD != "OCE",],
                        color = "#dbdade", fill = "#dbdade"),
                scale_fill_brewer(palette = "Blues", na.value = "#dcdcdc"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = oceancent_bound, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean50_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp126_mean))+
  geom_tile()+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg
  
#SSP5-8.5 2091-2100
p00_585 <- ocean_data |> 
  ggplot(aes(x, y, fill = rel_change_mean00_ssp585_mean))+
  geom_tile()+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
oceania_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                     labels = c("a", "b"), label_x = 0.1),
                           plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                     labels = c("c", "d"), label_x = 0.1),
                           #Using legends from Figure 3
                           plot_grid(leg_land, leg_fish, nrow = 1, ncol = 2), 
                           ncol = 1, nrow = 3, rel_heights = c(1, 1, 0.4))

#Removing variables not needed
rm(oceancent, oceancent_bound, eez_ocean)
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "oceania_perc_change_map_50-00.pdf"),
       oceania_plots, device = "pdf", width = 13, height = 8)
```
    
## Figure 15 FAO report - FAO regions
Finally, we will create maps for mean biomass change within the FAO regions.  
  
```{r}
#Listing all relevant files to calculate biomass projections
maps_data <- read_csv("data/ensemble_perc_bio_change_fao_map.csv")

#Add to FAO EEZ mask
choro_data_proj <- area_gfdl_df |> 
  left_join(maps_data, by = "ID_mrgd") |> 
  select(x, y, starts_with("rel_change")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```

  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_binned(limits = c(-50, 50), n.breaks = 8,
                                  type = scale_fill_custom, 
                                  oob = oob_squish),
                geom_sf(inherit.aes = F, data = fao_proj, fill = NA, 
                        colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, data = eez_proj, fill = "white",
                        colour = "white", show.legend = F, linewidth = 0.25),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F,
                        color = "#dbdade", fill = "#dbdade"),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_proj, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean50_ssp126_mean)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean50_ssp585_mean)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean00_ssp126_mean)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = choro_data_proj$rel_change_mean00_ssp585_mean)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg

#Plotting everything together
fao_reg_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1,
                                     labels = c("a", "b"), label_x = 0.1),
                           plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                     labels = c("c", "d"), label_x = 0.1),
                           leg_fish, ncol = 1, nrow = 3, 
                           rel_heights = c(1, 1, 0.4))
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "fao_regions_perc_change_map_50-00.pdf"),
       fao_reg_plots, device = "pdf", width = 14, height = 9)
```
  
## Figure 16 FAO report - FAO sustainable fisheries
Finally, we will create a choropleth map for the proportion of sustainable fisheries within FAO regions for 2019.  
  
```{r}
#Loading FAO fisheries data
fao_fisheries <- read_csv("data/prop_sustainable_fisheries_fao.csv")

fao_fisheries <- fao_proj |> 
  left_join(fao_fisheries, join_by(NAME_EN))
```
  
Finally, we can map this information.  
  
```{r}
fao_fisheries_plot <- ggplot()+
  #Plotting FAO classified by ocean basin
  geom_sf(data = fao_fisheries, aes(fill = OBS_VALUE))+
  geom_sf(data = eez_proj, fill = "white", colour = "white")+
  scale_fill_distiller(palette = "YlGnBu", direction = 1)+
  #Plotting base map
  geom_sf(data = world_proj, color = "#dbdade", fill = "#dbdade")+
  #Adding coastlines and international boundaries
  geom_sf(data = world_bound_proj, lwd = 0.25, color = "#484848", 
          show.legend = F, aes(linetype = as.factor(TYPE)))+
  scale_linetype_manual(values = c("0" = "solid", "1" = "twodash", 
                                   "2" = "dotdash", "3" = "dashed", 
                                   "4" = "dotted"))+
  geom_sf(data = world_bound_proj[world_bound_proj$TYPE == 8,], 
          linetype = "longdash", lwd = 0.25, color = "#838285", 
          show.legend = F)+
  #Removing grey background
  theme_bw()+
  #Formatting legend title
  guides(fill = guide_colorbar(title = "% sustainable fisheries", 
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  #Formatting legend
  theme(legend.position = "bottom", panel.border = element_rect(colour = NA),
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0))
```
  
```{r}
# Saving fisheries map
ggsave(file.path(out_folder, "fao_regions_perc_sustainable_fisheries.pdf"),
       fao_fisheries_plot, device = "pdf", width = 14, height = 9)
```
  
## Figure 18 FAO report - FAO standard deviation
  
```{r, eval = F}
#Load standard deviation
maps_data_sd <- read_csv("data/ensemble_sd_bio_change_data_map.csv")

#Extract data for scenario, transform to raster and reproject
maps_data_sd_proj <- maps_data_sd |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, ends_with("_sd")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```
  
```{r}
#Define base steps for maps
base_gg <- list(scale_fill_distiller(palette = "Blues", direction = 1, 
                                     na.value = NA, limits = c(0, 50), 
                                     oob = oob_squish),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F,
                        color = "#dbdade", fill = "#dbdade"),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA, 
                        colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_proj, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean50_ssp126_sd)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean50_ssp585_sd)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean00_ssp126_sd)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_sd_proj$rel_change_mean00_ssp585_sd)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "Standard deviation (%)",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")

#Get legend for land
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
all_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                 labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 3, 
                       rel_heights = c(1, 1, 0.4))
```
  
```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_sd_map_50-00.pdf"), all_plots, 
       device = "pdf", width = 14, height = 9)
```

## Figure Non-FAO report - Coefficient of variation 

```{r}
#Load coefficient of variation
maps_data_cv <- read_csv("data/ensemble_cv_bio_change_data_map.csv")

#Extract data for scenario, transform to raster and reproject
maps_data_cv_proj <- maps_data_cv |> 
  #Selecting coordinate columns and percentage change columns
  select(x, y, ends_with("_cv")) |> 
  #Transform to multi-layer raster
  rast(type = "xyz", crs = "epsg:4326") |> 
  #Reproject to Robinson
  project(y = rob_proj) 
```

```{r}
#Define base steps for maps
base_gg <- list(scale_fill_distiller(palette = "Blues", direction = 1, 
                                     na.value = NA, limits = c(0, 200), 
                                     oob = oob_squish),
                geom_sf(inherit.aes = F, data = world_proj, show.legend = F,
                        color = "#dbdade", fill = "#dbdade"),
                geom_sf(inherit.aes = F, data = eez_proj, fill = NA, 
                        colour = "#5b5b5b",
                        show.legend = F, linewidth = 0.25),
                #Adding coastlines and international boundaries
                geom_sf(inherit.aes = F, data = world_bound_proj, lwd = 0.25, 
                        color = "#484848", show.legend = F, 
                        aes(linetype = as.factor(TYPE))),
                scale_linetype_manual(values = c("0" = "solid",
                                                 "1" = "twodash", 
                                                 "2" = "dotdash", 
                                                 "3" = "dashed", 
                                                 "4" = "dotted")),
                geom_sf(inherit.aes = F, 
                        data = world_bound_proj[world_bound_proj$TYPE == 8,], 
                        linetype = "longdash", lwd = 0.25, color = "#838285",
                        show.legend = F),
                theme_bw(),
                theme(axis.title = element_blank(), 
                      panel.border = element_rect(colour = NA),
                      plot.title = element_text(hjust = 0.5),
                      legend.position = "none"))

#SSP1-2.6 2041-2050
p50_126 <- ggplot()+
  geom_spatraster(data = maps_data_cv_proj$rel_change_mean50_ssp126_cv)+
  labs(title = "SSP1-2.6: 2041-2050")+
  base_gg

#SSP5-8.5 2041-2050
p50_585 <- ggplot()+
  geom_spatraster(data = maps_data_cv_proj$rel_change_mean50_ssp585_cv)+
  labs(title = "SSP5-8.5: 2041-2050")+
  base_gg

#SSP1-2.6 2091-2100
p00_126 <- ggplot()+
  geom_spatraster(data = maps_data_cv_proj$rel_change_mean00_ssp126_cv)+
  labs(title = "SSP1-2.6: 2091-2100")+
  base_gg

#SSP5-8.5 2091-2100
p00_585 <- ggplot()+
  geom_spatraster(data = maps_data_cv_proj$rel_change_mean00_ssp585_cv)+
  labs(title = "SSP5-8.5: 2091-2100")+
  base_gg+
  guides(fill = guide_colorbar(title = "Coefficient of variation (%)",
                               title.position = "top", title.hjust = 0.5, 
                               barwidth = 15))+
  theme(legend.position = "bottom")

#Get legend for land
legend <- get_legend(p00_585)

#Remove legend from last plot
p00_585 <- p00_585+
  theme(legend.position = "none")

#Plotting everything together
all_plots <- plot_grid(plot_grid(p50_126, p50_585, ncol = 2, nrow = 1, 
                                 labels = c("a", "b"), label_x = 0.1),
                       plot_grid(p00_126, p00_585, ncol = 2, nrow = 1,
                                 labels = c("c", "d"), label_x = 0.1),
                       legend, ncol = 1, nrow = 3, 
                       rel_heights = c(1, 1, 0.4))
```

```{r}
# Saving multi-panel plot
ggsave(file.path(out_folder, "global_cv_map_50-00.pdf"), all_plots, 
       device = "pdf", width = 14, height = 9)
```

## Figure Non-FAO report - Model agreement 
Combining maps of percentage change, standard deviation (SD) and model agreement.  
  
```{r}
# model agreement, only for rel_change_mean00_ssp585? 
# Listing all relevant files to calculate biomass projections
maps_data_agreement_proj <- list.files(out_folder, 
                                       pattern = "perc_bio_change_data_map.csv", 
                                       full.names = T) |> 
  map_df(~fread(.)) |> 
  bind_rows() |>
  # consider only relevant columns 
  select(c(x:esm, starts_with("rel_change_mean00"))) |>
  #Restructuring data - longer format
  pivot_longer(starts_with("rel_change_mean00"), names_to = "scenario", 
               values_to = "value") |> 
  #Calculations performed by grid cell
  group_by(x, y, scenario) |> 
  #Calculate agreement across models
  summarise(n_model = n(), 
            n_positive = sum(value > 0, na.rm = T),
            n_negative = sum(value < 0, na.rm = T), 
            same_sign = max(n_positive, n_negative),
            # 0 land to be converted into NAs 
            agreement = (same_sign/n_model)*100) |> 
  #spread and gather have been superseded for a couple of years
  #use pivot_wider and pivot_longer instead
  spread(scenario) # GOT HERE - NEED TO FINISH

  
  
  
  
  # #Selecting coordinate columns and percentage change columns
  # select(x, y, ends_with("_agreement")) |> 
  # #Transform to multi-layer raster
  # rast(type = "xyz", crs = "epsg:4326") |> 
  # #Reproject to Robinson
  # project(y = rob_proj) 
```


